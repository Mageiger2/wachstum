<!DOCTYPE html>
<html lang="de" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sMArTHEMATIK - Beratung digitale Bildung</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        .page-transition { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes flyInStayFade {
            0% { transform: scale(0.2) translateY(50vh); opacity: 0; }
            15% { transform: scale(1.1) translateY(0); opacity: 1; }
            25% { transform: scale(1) translateY(0); opacity: 1; }
            75% { transform: scale(1) translateY(0); opacity: 1; }
            100% { transform: scale(1.5) translateY(-30vh); opacity: 0; }
        }
        .animate-fly-logo { animation: flyInStayFade 3.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        
        body { background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .font-math { font-family: 'Times New Roman', Times, serif; }
    </style>
</head>
<body class="text-slate-800 font-sans antialiased flex flex-col min-h-screen">

    <div id="root" class="flex flex-col min-h-screen"></div>

    <script type="text/babel" data-presets="typescript,react">
        const { useState, useEffect } = React;

        // ==========================================
        // 0. HELPERS (Storage & Animation)
        // ==========================================
        const getStorage = (key, def) => { try { return parseInt(localStorage.getItem(key)) || def; } catch(e) { return def; } };
        const setStorage = (key, val) => { try { localStorage.setItem(key, val); } catch(e) {} };

        const triggerCelebration = (setShowAnim) => {
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, zIndex: 101 });
            setShowAnim(true);
            setTimeout(() => setShowAnim(false), 3500);
        };

        const CelebrationOverlay = () => (
            <div className="fixed inset-0 z-[100] flex items-center justify-center pointer-events-none">
                <img src="Logo-sMArTH.png" className="w-[80vw] max-w-md drop-shadow-2xl animate-fly-logo bg-white/80 p-4 rounded-3xl backdrop-blur-sm" alt="Logo" 
                     onError={(e)=>{e.target.style.display='none'}} />
            </div>
        );

        // ==========================================
        // 1. ICONS
        // ==========================================
        const IconBase = ({ path, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
        const Calculator = ({ className }) => <IconBase className={className} path={<><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></>} />;
        const CalculatorOff = ({ className }) => <IconBase className={className} path={<><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/><line x1="2" y1="2" x2="22" y2="22"/></>} />;
        const CheckCircle = ({ className }) => <IconBase className={className} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
        const XCircle = ({ className }) => <IconBase className={className} path={<><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></>} />;
        const RefreshCw = ({ className }) => <IconBase className={className} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} />;
        const BookOpen = ({ className }) => <IconBase className={className} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />;
        const TrendingUp = ({ className }) => <IconBase className={className} path={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>} />;
        const TrendingDown = ({ className }) => <IconBase className={className} path={<><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></>} />;
        const ArrowRight = ({ className }) => <IconBase className={className} path={<><line x1="5" x2="19" y1="12" y2="12"/><polyline points="12 5 19 12 12 19"/></>} />;
        const ChevronRight = ({ className }) => <IconBase className={className} path={<><polyline points="9 18 15 12 9 6"/></>} />;
        const HomeIcon = ({ className }) => <IconBase className={className} path={<><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>} />;
        const MenuIcon = ({ className }) => <IconBase className={className} path={<><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></>} />;
        const Shield = ({ className }) => <IconBase className={className} path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></>} />;
        const FileText = ({ className }) => <IconBase className={className} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><polyline points="10 9 9 9 8 9"/></>} />;
        const DeleteIcon = ({ className }) => <IconBase className={className} path={<><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><line x1="18" y1="9" x2="12" y2="15"/><line x1="12" y1="9" x2="18" y2="15"/></>} />;
        const HelpCircle = ({ className }) => <IconBase className={className} path={<><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />;
        const FastForward = ({ className }) => <IconBase className={className} path={<><polygon points="13 19 22 12 13 5 13 19"/><polygon points="2 19 11 12 2 5 2 19"/></>} />;
        const Target = ({ className }) => <IconBase className={className} path={<><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></>} />;
        const FractionIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="4" x2="20" y1="12" y2="12"/><path d="M11 7 L12 5 L12 9" /><path d="M10 15 L14 19 M14 15 L10 19" />
            </svg>
        );

        // ==========================================
        // 2. SHARED COMPONENTS 
        // ==========================================
        const themeColors = {
            emerald: { activeBorder: 'border-emerald-500', activeBg: 'bg-emerald-50', activeTitle: 'text-emerald-900', badgeBg: 'bg-emerald-600', shadow: 'shadow-emerald-100', btnBg: 'bg-emerald-600', btnHover: 'hover:bg-emerald-700' },
            rose: { activeBorder: 'border-rose-400', activeBg: 'bg-rose-50', activeTitle: 'text-rose-900', badgeBg: 'bg-rose-500', shadow: 'shadow-rose-100', btnBg: 'bg-rose-500', btnHover: 'hover:bg-rose-600' },
            amber: { activeBorder: 'border-amber-400', activeBg: 'bg-amber-50', activeTitle: 'text-amber-900', badgeBg: 'bg-amber-500', shadow: 'shadow-amber-100', btnBg: 'bg-amber-500', btnHover: 'hover:bg-amber-600' },
            sky: { activeBorder: 'border-sky-400', activeBg: 'bg-sky-50', activeTitle: 'text-sky-900', badgeBg: 'bg-sky-500', shadow: 'shadow-sky-100', btnBg: 'bg-sky-500', btnHover: 'hover:bg-sky-600' }
        };

        const Frac = ({ top, bot }) => <span className="inline-flex flex-col items-center align-middle mx-1 px-1"><span className="border-b-[1.5px] border-current px-1 pb-0.5 w-full text-center leading-none">{top}</span><span className="px-1 pt-0.5 text-center leading-none">{bot}</span></span>;

        const StepCard = ({ title, stepNum, currentStep, theme = 'amber', children }) => {
            const isPast = currentStep > stepNum;
            const isActive = currentStep === stepNum;
            const t = themeColors[theme];

            return (
                <div className={`bg-white rounded-xl shadow-sm border-2 overflow-hidden transition-all duration-300 ${isActive ? `${t.activeBorder} ${t.shadow}` : isPast ? 'border-green-200' : 'border-slate-200 opacity-50'}`}>
                    <div className={`px-5 py-3 border-b flex items-center ${isActive ? `${t.activeBg} border-opacity-50` : isPast ? 'bg-green-50 border-green-100' : 'bg-slate-50 border-slate-200'}`}>
                        {isPast ? <CheckCircle className="text-green-500 mr-3 w-6 h-6 shrink-0" /> : <div className={`w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold mr-3 shrink-0 ${isActive ? `${t.badgeBg} text-white` : 'bg-slate-300 text-slate-500'}`}>{stepNum}</div>}
                        <h3 className={`font-bold text-lg ${isActive ? t.activeTitle : isPast ? 'text-green-900' : 'text-slate-500'}`}>{title}</h3>
                    </div>
                    <div className={`p-5 ${!isActive && !isPast ? 'hidden' : ''}`}>{children}</div>
                </div>
            );
        };

        const SubmitBtn = ({ onClick, theme = 'amber' }) => {
            const t = themeColors[theme];
            return <button onClick={onClick} className={`${t.btnBg} ${t.btnHover} text-white p-2.5 rounded shadow flex items-center transition-colors`} title="ÃœberprÃ¼fen"><ArrowRight className="w-5 h-5" /></button>;
        };

        const SuccessMark = ({ text }) => (
            <div className="mt-4 text-green-700 font-medium flex items-center bg-green-50 px-3 py-2 rounded-lg border border-green-100 inline-flex"><CheckCircle className="w-5 h-5 mr-2 text-green-600 shrink-0" /> {text}</div>
        );

        const TipBox = ({ errors, revealed, setRevealed, text }) => {
            if (errors < 3) return null;
            if (!revealed) {
                return (
                    <button onClick={() => setRevealed(true)} className="mt-4 text-amber-600 bg-amber-50 hover:bg-amber-100 px-4 py-2 rounded-lg font-medium flex items-center transition-colors border border-amber-200 animate-fade-in">
                        <HelpCircle className="w-5 h-5 mr-2" /> Hier gibt es einen Tipp
                    </button>
                );
            }
            return (
                <div className="mt-4 bg-amber-50 border-l-4 border-amber-500 p-4 rounded shadow-sm text-amber-900 text-sm animate-fade-in flex">
                    <HelpCircle className="w-6 h-6 mr-3 shrink-0 text-amber-600" />
                    <div><strong className="block mb-1 text-amber-800">Tipp:</strong> {text}</div>
                </div>
            );
        };

        const formatNum = (num) => { if (num === null || num === undefined) return ""; return num.toString().replace('.', ','); };
        const VarWn = () => <span>W<sub>n</sub></span>; const VarW0 = () => <span>W<sub>0</sub></span>; const VarQ = () => <span>q</span>; const VarN = () => <span>n</span>; const VarQpowN = () => <span>q<sup>n</sup></span>;

        const FormulaInput = ({ id, label, value, isUnknown, status, disabled, onChange, theme = "emerald" }) => {
            const isRose = theme === 'rose'; const isEmerald = theme === 'emerald';
            return (
                <div className="flex flex-col items-center">
                    <div className="mb-1 text-slate-500 font-serif italic text-lg">{label}</div>
                    {isUnknown ? (
                        <div className={`w-20 md:w-24 h-12 rounded-lg border-2 flex items-center justify-center font-bold select-none shadow-sm ${isRose ? 'border-rose-300 bg-rose-50 text-rose-400' : isEmerald ? 'border-emerald-300 bg-emerald-50 text-emerald-400' : 'border-amber-300 bg-amber-50 text-amber-400'}`}>?</div>
                    ) : (
                        <div className="relative">
                            <input type="text" value={value} disabled={disabled} onChange={(e) => onChange(id, e.target.value)} className={`w-20 md:w-24 h-12 text-center rounded-lg border-2 text-lg outline-none transition-colors shadow-sm ${status === 'correct' ? 'border-green-500 bg-green-50 text-green-900 font-bold' : status === 'incorrect' ? 'border-red-400 bg-red-50' : `border-slate-300 focus:border-${theme}-500 focus:ring-2 focus:ring-${theme}-200`}`} placeholder="..." />
                            {status === 'correct' && <CheckCircle className="w-5 h-5 text-green-600 absolute -top-2 -right-2 bg-white rounded-full shadow-sm" />}
                        </div>
                    )}
                </div>
            );
        };

        const MiniFormulaInput = ({ id, value, isUnknown, status, disabled, onChange }) => {
            if (isUnknown) return <div className="w-12 h-8 rounded border-2 flex items-center justify-center font-bold select-none border-rose-300 bg-rose-50 text-rose-400 text-sm">?</div>;
            return (
                <div className="relative">
                    <input type="text" value={value} disabled={disabled} onChange={(e) => onChange(id, e.target.value)} className={`w-12 h-8 text-center rounded border-2 text-sm outline-none transition-colors shadow-sm ${status === 'correct' ? 'border-green-500 bg-green-50 text-green-900 font-bold' : status === 'incorrect' ? 'border-red-400 bg-red-50' : `border-slate-300 focus:border-rose-500`}`} placeholder="..." />
                    {status === 'correct' && <CheckCircle className="w-3 h-3 text-green-600 absolute -top-1 -right-1 bg-white rounded-full" />}
                </div>
            );
        };

        // ==========================================
        // 3. WACHSTUMS- & ZERFALLSTRAINER
        // ==========================================

        const WachstumsTrainer = () => {
            const [difficulty, setDifficulty] = useState('normal'); 
            const [problem, setProblem] = useState(null);
            const [step, setStep] = useState(1); 
            const [selectedIdentification, setSelectedIdentification] = useState(null);
            const [inputs, setInputs] = useState({ wn: '', w0: '', q: '', n: '' });
            const [inputFeedback, setInputFeedback] = useState({});
            const [options, setOptions] = useState([]);
            const [selectedOptionId, setSelectedOptionId] = useState(null);
            const [finalAnswer, setFinalAnswer] = useState('');
            const [finalFeedback, setFinalFeedback] = useState(null);
            const [showSolution, setShowSolution] = useState(false);
            const [streak, setStreak] = useState(() => getStorage('smarth_streak_wachstum', 0));
            const [loading, setLoading] = useState(true);
            const [sequenceIndex, setSequenceIndex] = useState(0);
            
            const [errors, setErrors] = useState(0);
            const [tipRevealed, setTipRevealed] = useState(false);
            const [showAnim, setShowAnim] = useState(false);

            useEffect(() => { setStorage('smarth_streak_wachstum', streak); }, [streak]);
            const advance = (nextStep) => { setStep(nextStep); setErrors(0); setTipRevealed(false); };
            const triggerError = () => { setErrors(e => e + 1); setStreak(0); };

            const round = (num, decimals = 2) => Math.round(num * Math.pow(10, decimals)) / Math.pow(10, decimals);
            const handleInputChange = (id, val) => { setInputs(prev => ({ ...prev, [id]: val.replace('.', ',') })); setInputFeedback(prev => ({ ...prev, [id]: null })); };

            const generateProblem = () => {
                setLoading(true); setStep(1); setSelectedIdentification(null); setInputs({ wn: '', w0: '', q: '', n: '' }); setInputFeedback({});
                setOptions([]); setSelectedOptionId(null); setFinalAnswer(''); setFinalFeedback(null); setShowSolution(false); setErrors(0); setTipRevealed(false);

                const scenarios = ['money', 'population', 'depreciation', 'cooling'];
                const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
                const sequenceOrder = ['Wn', 'rate', 'W0', 'n'];
                const type = sequenceOrder[sequenceIndex % sequenceOrder.length];
                setSequenceIndex(prev => prev + 1);

                let w0, rate, n, q, wn, unit;
                let isGrowth = (scenario === 'money' || scenario === 'population');

                switch (scenario) {
                    case 'money': unit = "â‚¬"; w0 = Math.floor(Math.random() * 50) * 100 + 500; rate = round(Math.random() * 4 + 0.5, 1); n = Math.floor(Math.random() * 10) + 2; break;
                    case 'population': unit = "Einwohner"; w0 = Math.floor(Math.random() * 50) * 1000 + 10000; rate = round(Math.random() * 2 + 0.5, 1); n = Math.floor(Math.random() * 15) + 5; break;
                    case 'depreciation': unit = "â‚¬"; w0 = Math.floor(Math.random() * 20) * 1000 + 15000; rate = Math.floor(Math.random() * 10) + 8; n = Math.floor(Math.random() * 6) + 3; break;
                    case 'cooling': unit = "Â°C"; w0 = Math.floor(Math.random() * 60) + 40; rate = Math.floor(Math.random() * 15) + 5; n = Math.floor(Math.random() * 10) + 2; break;
                }

                q = isGrowth ? round(1 + rate / 100, 4) : round(1 - rate / 100, 4);
                wn = round(w0 * Math.pow(q, n), 2);
                if (unit === 'Einwohner') wn = Math.round(wn);

                const w0_f = formatNum(w0); const wn_f = formatNum(wn); const rate_f = formatNum(rate);

                let questionText = "";
                const timeUnit = (scenario === 'cooling') ? 'Minuten' : 'Jahren';
                const timeAdverb = (scenario === 'cooling') ? 'minÃ¼tlich' : 'jÃ¤hrlich';
                const actionWord = isGrowth ? 'wÃ¤chst/steigt' : 'sinkt/fÃ¤llt';
                const valWord = (scenario === 'money' || scenario === 'depreciation') ? 'Wert/Kapital' : (scenario === 'cooling' ? 'Temperatur' : 'Bestand');

                if (difficulty === 'schwer' && timeUnit === 'Jahren') {
                    let y1 = 2010 + Math.floor(Math.random()*8); let y2 = y1 + n;
                    switch (type) {
                        case 'Wn': questionText = `Im Jahr ${y1} lag der ${valWord} bei ${w0_f} ${unit}. Er ${actionWord} ${timeAdverb} um ${rate_f} %. Wie hoch ist er im Jahr ${y2}?`; break;
                        case 'W0': questionText = `Im Jahr ${y2} liegt der ${valWord} bei ${wn_f} ${unit}, nachdem er seit ${y1} ${timeAdverb} um ${rate_f} % ${actionWord === 'wÃ¤chst/steigt' ? 'gestiegen' : 'gesunken'} ist. Wie hoch war er ${y1}?`; break;
                        case 'rate': questionText = `Der ${valWord} hat sich von ${y1} (${w0_f} ${unit}) bis ${y2} (${wn_f} ${unit}) verÃ¤ndert. Wie hoch war die jÃ¤hrliche prozentuale VerÃ¤nderung?`; break;
                        case 'n': questionText = `Startwert: ${w0_f} ${unit}. Er ${actionWord} um ${rate_f} % pro Jahr. Nach wie vielen Jahren wird ${wn_f} ${unit} erreicht?`; break; 
                    }
                } else {
                    switch (type) {
                        case 'Wn': questionText = `Ein ${valWord} von ${w0_f} ${unit} ${actionWord} ${timeAdverb} um ${rate_f} %. Zeitraum: ${n} ${timeUnit}.`; break;
                        case 'W0': questionText = `Nach ${n} ${timeUnit} ist ein ${valWord} auf ${wn_f} ${unit} ${actionWord === 'wÃ¤chst/steigt' ? 'gestiegen' : 'gesunken'}. Die VerÃ¤nderung betrug ${rate_f} %.`; break;
                        case 'rate': questionText = `Ein ${valWord} hat sich in ${n} ${timeUnit} von ${w0_f} ${unit} auf ${wn_f} ${unit} verÃ¤ndert.`; break;
                        case 'n': questionText = `Startwert: ${w0_f} ${unit}. Endwert: ${wn_f} ${unit}. VerÃ¤nderung: ${rate_f} % pro ${timeUnit === 'Minuten' ? 'Minute' : 'Jahr'}.`; break;
                    }
                }
                questionText += " Was musst du berechnen?";

                let explanation = `Gegeben:\n${type !== 'W0' ? `W0 = ${formatNum(w0)} ${unit}\n` : ''}${type !== 'Wn' ? `Wn = ${formatNum(wn)} ${unit}\n` : ''}${type !== 'n' ? `n = ${n}\n` : ''}${type !== 'rate' ? `p = ${formatNum(rate)}%  =>  q = ${formatNum(q)}\n` : ''}\nRechnung:\n`;
                if (type === 'Wn') explanation += `Wn = ${w0_f} Â· ${formatNum(q)}^${n} = ${wn_f}`;
                if (type === 'W0') explanation += `W0 = ${wn_f} / ${formatNum(q)}^${n} = ${w0_f}`;
                if (type === 'rate') explanation += `q = (${wn_f}/${w0_f})^(1/${n}) = ${formatNum(q)} => p=${rate_f}%`;
                if (type === 'n') explanation += `n = log(${wn_f}/${w0_f}) / log(${formatNum(q)}) = ${n}`;

                setProblem({ type, scenario, text: questionText, w0, wn, rate, q, n, unit, solution: type === 'rate' ? rate : (type === 'n' ? n : (type === 'W0' ? w0 : wn)), explanation });
                
                let opts = [];
                switch (type) {
                    case 'Wn': opts = [{ id: '1', label: 'Formel ist bereits aufgelÃ¶st. Einfach ausrechnen.', isCorrect: true }, { id: '2', label: <span>Teile durch <VarW0/></span>, isCorrect: false }, { id: '3', label: <span>Ziehe die {n}-te Wurzel</span>, isCorrect: false }]; break;
                    case 'W0': opts = [{ id: '1', label: <span>Teile durch <VarQpowN/></span>, isCorrect: true }, { id: '2', label: <span>Multipliziere mit <VarQpowN/></span>, isCorrect: false }, { id: '3', label: <span>Subtrahiere <VarQpowN/></span>, isCorrect: false }]; break;
                    case 'rate': opts = [{ id: '1', label: <span>1. Teile durch <VarW0/> <br/> 2. Ziehe die {n}-te Wurzel</span>, isCorrect: true }, { id: '2', label: <span>1. Teile durch <VarW0/> <br/> 2. Teile durch {n}</span>, isCorrect: false }, { id: '3', label: <span>1. Teile durch {n} <br/> 2. Ziehe die Wurzel</span>, isCorrect: false }]; break;
                    case 'n': opts = [{ id: '1', label: <span>1. Teile durch <VarW0/> <br/> 2. Wende den Logarithmus an</span>, isCorrect: true }, { id: '2', label: <span>1. Teile durch <VarQ/> <br/> 2. Wende den Logarithmus an</span>, isCorrect: false }, { id: '3', label: <span>1. Teile durch <VarW0/> <br/> 2. Ziehe die {n}-te Wurzel</span>, isCorrect: false }]; break;
                }
                setOptions(opts.sort(() => Math.random() - 0.5)); setLoading(false);
            };

            useEffect(() => { generateProblem(); }, [difficulty]);

            const handleDifficultyChange = (newDiff) => {
                if (difficulty === newDiff) generateProblem(); else setDifficulty(newDiff);
            };

            const handleIdentify = (selected) => {
                if (step > 1 || !problem) return;
                setSelectedIdentification(selected);
                if (selected === problem.type) { setTimeout(() => advance(2), 600); } else { triggerError(); }
            };

            const checkFormulaInputs = () => {
                if (!problem) return;
                let allCorrect = true, feedback = {};
                const checkVal = (input, target) => { const val = parseFloat(input.replace(',', '.')); if (isNaN(val)) return false; return Math.abs(val - target) < (Math.max(target * 0.01, 0.005)); };
                if (problem.type !== 'Wn' && !checkVal(inputs.wn, problem.wn)) { feedback.wn = 'incorrect'; allCorrect = false; } else feedback.wn = 'correct';
                if (problem.type !== 'W0' && !checkVal(inputs.w0, problem.w0)) { feedback.w0 = 'incorrect'; allCorrect = false; } else feedback.w0 = 'correct';
                if (problem.type !== 'rate' && !checkVal(inputs.q, problem.q)) { feedback.q = 'incorrect'; allCorrect = false; } else feedback.q = 'correct';
                if (problem.type !== 'n' && !checkVal(inputs.n, problem.n)) { feedback.n = 'incorrect'; allCorrect = false; } else feedback.n = 'correct';
                setInputFeedback(feedback); 
                if (allCorrect) advance(3); else triggerError();
            };

            const handleOptionSelect = (opt) => {
                if (step > 3) return;
                setSelectedOptionId(opt.id);
                if (opt.isCorrect) { setTimeout(() => advance(4), 600); } else { triggerError(); }
            };

            const checkFinalResult = () => {
                if (!problem) return;
                const val = parseFloat(finalAnswer.replace(',', '.')); if (isNaN(val)) return;
                const tolerance = problem.type === 'n' ? 0.5 : (problem.solution * 0.01);
                if (Math.abs(val - problem.solution) <= tolerance || (problem.type === 'n' && Math.round(val) === problem.solution)) {
                    setFinalFeedback('correct'); 
                    const newStreak = streak + 1;
                    setStreak(newStreak);
                    if (newStreak > 0 && newStreak % 3 === 0) triggerCelebration(setShowAnim);
                    setShowSolution(true); advance(5);
                } else { setFinalFeedback('incorrect'); triggerError(); }
            };

            return (
                <div className="page-transition max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    {showAnim && <CelebrationOverlay />}
                    <header className="bg-emerald-700 text-emerald-50 shadow-md p-6 rounded-xl mb-6">
                        <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div className="flex items-center space-x-3">
                                <TrendingUp size={32} />
                                <div>
                                    <h1 className="text-2xl font-bold tracking-tight text-white flex items-center">Wachstum & Zerfall <span className="hidden sm:inline text-emerald-200 text-lg font-normal border-l-2 border-emerald-400 pl-2 ml-2">10. Klasse</span></h1>
                                </div>
                            </div>
                            <div className="bg-emerald-800 px-4 py-1.5 rounded-full text-sm font-bold shadow-sm flex items-center">
                                <TrendingUp className="w-4 h-4 mr-2 text-emerald-300" /> Streak: {streak}
                            </div>
                        </div>
                    </header>

                    <div className="flex flex-col sm:flex-row items-center justify-center gap-3 mb-6 bg-white p-3 rounded-xl shadow-sm border border-slate-200">
                        <span className="font-bold text-slate-700">Neue Aufgabe generieren:</span>
                        <div className="flex gap-2">
                            <button onClick={() => handleDifficultyChange('normal')} className={`px-4 py-2 font-bold rounded-lg shadow-sm transition-colors ${difficulty === 'normal' ? 'bg-emerald-600 text-white' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'}`}>Normal</button>
                            <button onClick={() => handleDifficultyChange('schwer')} className={`px-4 py-2 font-bold rounded-lg shadow-sm transition-colors ${difficulty === 'schwer' ? 'bg-emerald-600 text-white' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'}`}>Schwer</button>
                        </div>
                    </div>

                    <main className="space-y-6 relative">
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="bg-emerald-50 px-6 py-3 border-b border-emerald-200 flex justify-between items-center">
                                <h2 className="font-semibold text-emerald-900 flex items-center"><BookOpen size={18} className="mr-2"/> Sachaufgabe</h2>
                            </div>
                            <div className="p-6 bg-white min-h-[100px] flex items-center justify-center text-center">
                                {loading ? <RefreshCw className="w-8 h-8 animate-spin text-emerald-500"/> : <p className="text-xl font-medium leading-relaxed">{problem?.text}</p>}
                            </div>
                        </div>

                        <div className="space-y-4">
                            <StepCard title="1. Was ist gesucht?" stepNum={1} currentStep={step} theme="emerald">
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                    {[{ type: 'Wn', label: <VarWn/>, desc: "Endwert" }, { type: 'W0', label: <VarW0/>, desc: "Anfangswert" }, { type: 'rate', label: <VarQ/>, desc: "Faktor" }, { type: 'n', label: <VarN/>, desc: "Laufzeit" }].map((item) => (
                                        <button key={item.type} onClick={() => handleIdentify(item.type)} disabled={step > 1} className={`p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-1 ${selectedIdentification === item.type ? (item.type === problem?.type ? 'border-green-500 bg-green-50 text-green-900 font-bold' : 'border-red-400 bg-red-50 text-red-900') : 'border-slate-200 hover:border-emerald-400 bg-white'}`}>
                                            <span className="text-xl font-serif font-bold">{item.label}</span><span className="text-[10px] sm:text-xs uppercase font-semibold text-slate-500">{item.desc}</span>
                                        </button>
                                    ))}
                                </div>
                                {step === 1 && <TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text="Lies genau: Frag nach dem Start (W0), dem Ende (Wn) oder der Dauer (n)?" />}
                                {step > 1 && <SuccessMark text="Richtig identifiziert!" />}
                            </StepCard>

                            {step >= 2 && (
                                <StepCard title="2. Werte in die Formel einsetzen" stepNum={2} currentStep={step} theme="emerald">
                                    <div className="flex flex-wrap items-center justify-center gap-2 md:gap-4 bg-slate-50 p-4 sm:p-6 rounded-xl border border-dashed border-slate-300">
                                        <FormulaInput id="wn" label={<VarWn/>} value={inputs.wn} theme="emerald" isUnknown={problem.type === 'Wn'} status={inputFeedback.wn} disabled={step > 2 || inputFeedback.wn === 'correct'} onChange={handleInputChange} />
                                        <span className="text-2xl text-slate-400 font-bold mt-6">=</span>
                                        <FormulaInput id="w0" label={<VarW0/>} value={inputs.w0} theme="emerald" isUnknown={problem.type === 'W0'} status={inputFeedback.w0} disabled={step > 2 || inputFeedback.w0 === 'correct'} onChange={handleInputChange} />
                                        <span className="text-2xl text-slate-400 font-bold mt-6">Â·</span>
                                        <FormulaInput id="q" label={<VarQ/>} value={inputs.q} theme="emerald" isUnknown={problem.type === 'rate'} status={inputFeedback.q} disabled={step > 2 || inputFeedback.q === 'correct'} onChange={handleInputChange} />
                                        <div className="relative -top-6"><FormulaInput id="n" label={<span className="text-sm"><VarN/></span>} value={inputs.n} theme="emerald" isUnknown={problem.type === 'n'} status={inputFeedback.n} disabled={step > 2 || inputFeedback.n === 'correct'} onChange={handleInputChange} /></div>
                                    </div>
                                    {step === 2 && <div className="mt-4 flex justify-between items-center"><TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text={difficulty==='schwer'?"n ist die Differenz der Jahre. Bei Abnahme ist q < 1 (z.B. 1 - 0.05).":"q ist (1 + p/100) bei Zunahme und (1 - p/100) bei Abnahme."} /><SubmitBtn onClick={checkFormulaInputs} theme="emerald" /></div>}
                                    {step > 2 && <SuccessMark text="Alle Werte richtig eingesetzt!" />}
                                </StepCard>
                            )}

                            {step >= 3 && (
                                <StepCard title="3. Gleichung umformen" stepNum={3} currentStep={step} theme="emerald">
                                    <div className="flex justify-center items-center gap-2 text-xl md:text-2xl font-mono bg-slate-100 py-4 px-2 rounded-lg mb-6 text-slate-700">
                                        <span>{problem.type === 'Wn' ? <span className="text-emerald-700 font-bold">Wn</span> : formatNum(problem.wn)} = {problem.type === 'W0' ? <span className="text-emerald-700 font-bold">W0</span> : formatNum(problem.w0)} Â· {problem.type === 'rate' ? <span className="text-emerald-700 font-bold">q</span> : formatNum(problem.q)}<sup>{problem.type === 'n' ? <span className="text-emerald-700 font-bold">n</span> : problem.n}</sup></span>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                        {options.map((opt) => (
                                            <button key={opt.id} onClick={() => handleOptionSelect(opt)} disabled={step > 3} className={`p-4 rounded-xl border-2 text-sm md:text-base font-medium flex flex-col items-center justify-center gap-2 ${selectedOptionId === opt.id ? (opt.isCorrect ? 'border-green-500 bg-green-50 text-green-900 font-bold' : 'border-red-400 bg-red-50 text-red-900') : 'border-slate-200 hover:border-emerald-400'}`}>
                                                {opt.label}
                                            </button>
                                        ))}
                                    </div>
                                    {step === 3 && <TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text="Um W0 freizustellen: teile durch q^n. FÃ¼r n: teile durch W0 und nutze den Logarithmus." />}
                                    {step > 3 && <SuccessMark text="Richtig umgeformt!" />}
                                </StepCard>
                            )}

                            {step >= 4 && (
                                <StepCard title="4. Ergebnis berechnen" stepNum={4} currentStep={step} theme="emerald">
                                    <div className="flex flex-col sm:flex-row gap-4 items-center w-full">
                                        <div className="relative flex-grow max-w-sm w-full">
                                            <span className="absolute left-4 top-1/2 -translate-y-1/2 font-serif text-slate-400 italic">{problem.type === 'Wn' ? <VarWn/> : problem.type === 'W0' ? <VarW0/> : problem.type === 'rate' ? 'p' : <VarN/>} =</span>
                                            <input type="text" value={finalAnswer} onChange={(e) => setFinalAnswer(e.target.value.replace('.', ','))} disabled={step === 5} placeholder="Rechner nutzen..." className={`pl-16 pr-12 py-3 w-full rounded-lg border-2 text-lg outline-none transition-colors shadow-sm ${finalFeedback === 'correct' ? 'border-green-500 bg-green-50 text-green-900 font-bold' : finalFeedback === 'incorrect' ? 'border-red-400 bg-red-50' : 'border-slate-300 focus:border-emerald-500'}`} />
                                            <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm font-medium">{problem.type === 'rate' ? '%' : problem.unit}</span>
                                        </div>
                                        {step === 4 && <SubmitBtn onClick={checkFinalResult} theme="emerald" />}
                                    </div>
                                    {step === 4 && <TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text="Achte beim Taschenrechner auf Kommas und Klammern (z.B. log(Endwert/Startwert))." />}
                                    {step > 4 && <SuccessMark text="Perfekt gerechnet!" />}
                                </StepCard>
                            )}

                            {step === 5 && (
                                <div className="bg-green-50 border-2 border-green-500 p-8 rounded-xl shadow-sm text-center animate-fade-in mt-6">
                                    <h3 className="text-3xl font-bold text-green-800 mb-3">Klasse gemacht! ðŸŽ‰</h3>
                                    <div className="flex flex-col sm:flex-row justify-center gap-4 mt-6">
                                        <button onClick={() => setShowSolution(!showSolution)} className="text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-medium shadow-sm"><BookOpen className="w-4 h-4"/> LÃ¶sungsweg</button>
                                        <button onClick={generateProblem} className="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-lg font-bold shadow-md flex items-center justify-center gap-2"><RefreshCw className="w-5 h-5" /> NÃ¤chste Aufgabe</button>
                                    </div>
                                    {showSolution && <div className="w-full bg-white p-6 rounded-xl border border-green-200 mt-6 text-sm font-mono whitespace-pre-line text-slate-700 text-left shadow-inner">{problem.explanation}</div>}
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const ZerfallsTrainer = () => {
            const [difficulty, setDifficulty] = useState('normal'); 
            const [problem, setProblem] = useState(null);
            const [step, setStep] = useState(1); 
            const [selectedIdentification, setSelectedIdentification] = useState(null);
            const [inputs, setInputs] = useState({ wn: '', w0: '', t: '', thalf: '' });
            const [inputFeedback, setInputFeedback] = useState({});
            const [options, setOptions] = useState([]);
            const [selectedOptionId, setSelectedOptionId] = useState(null);
            const [finalAnswer, setFinalAnswer] = useState('');
            const [finalFeedback, setFinalFeedback] = useState(null);
            const [showSolution, setShowSolution] = useState(false);
            const [streak, setStreak] = useState(() => getStorage('smarth_streak_zerfall', 0));
            const [loading, setLoading] = useState(true);
            const [sequenceIndex, setSequenceIndex] = useState(0);

            const [errors, setErrors] = useState(0);
            const [tipRevealed, setTipRevealed] = useState(false);
            const [showAnim, setShowAnim] = useState(false);

            useEffect(() => { setStorage('smarth_streak_zerfall', streak); }, [streak]);
            const advance = (nextStep) => { setStep(nextStep); setErrors(0); setTipRevealed(false); };
            const triggerError = () => { setErrors(e => e + 1); setStreak(0); };

            const round = (num, decimals = 2) => Math.round(num * Math.pow(10, decimals)) / Math.pow(10, decimals);
            const handleInputChange = (id, val) => { setInputs(prev => ({ ...prev, [id]: val.replace('.', ',') })); setInputFeedback(prev => ({ ...prev, [id]: null })); };

            const generateProblem = () => {
                setLoading(true); setStep(1); setSelectedIdentification(null); setInputs({ wn: '', w0: '', t: '', thalf: '' }); setInputFeedback({});
                setOptions([]); setSelectedOptionId(null); setFinalAnswer(''); setFinalFeedback(null); setShowSolution(false); setErrors(0); setTipRevealed(false);

                // Halbwertszeit: q is ALWAYS 0.5. Exponent is t / T_1/2
                const scenarios = ['radioactivity', 'medicine'];
                const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
                const sequenceOrder = ['Wn', 'W0', 't']; 
                const type = sequenceOrder[sequenceIndex % sequenceOrder.length];
                setSequenceIndex(prev => prev + 1);

                let w0, t, thalf, wn, unit, timeUnit;
                const q = 0.5;

                switch (scenario) {
                    case 'radioactivity': unit = "mg"; timeUnit = "Tagen"; w0 = Math.floor(Math.random() * 100) * 10 + 500; thalf = Math.floor(Math.random() * 8) + 2; t = thalf * (Math.floor(Math.random() * 5) + 2); break;
                    case 'medicine': unit = "mg"; timeUnit = "Stunden"; w0 = Math.floor(Math.random() * 40) * 10 + 200; thalf = Math.floor(Math.random() * 6) + 2; t = thalf * (Math.floor(Math.random() * 4) + 2); break;
                }

                if (difficulty === 'schwer') {
                    t = Math.floor(Math.random() * 12) + 5;
                    thalf = Math.floor(Math.random() * 5) + 2;
                }

                wn = round(w0 * Math.pow(q, t / thalf), 2);
                const w0_f = formatNum(w0); const wn_f = formatNum(wn);

                let questionText = "";
                const valWord = (scenario === 'medicine' ? 'Wirkstoffmenge' : 'Masse');

                if (difficulty === 'schwer') {
                    questionText = `Ein Labor untersucht eine Probe. Die Halbwertszeit betrÃ¤gt ${thalf} ${timeUnit}. `;
                    switch (type) {
                        case 'Wn': questionText += `Zu Beginn lag der Wert bei ${w0_f} ${unit}. Wie viel ist nach ${t} ${timeUnit} noch messbar?`; break;
                        case 'W0': questionText += `Nach genau ${t} ${timeUnit} kÃ¶nnen noch ${wn_f} ${unit} nachgewiesen werden. Wie hoch war die Ausgangsmenge?`; break;
                        case 't': questionText += `Der Startwert betrug ${w0_f} ${unit}. Jetzt sind es nur noch ${wn_f} ${unit}. Wie viele ${timeUnit} sind vergangen?`; break;
                    }
                } else {
                    switch (type) {
                        case 'Wn': questionText = `Eine ${valWord} von ${w0_f} ${unit} hat eine Halbwertszeit von ${thalf} ${timeUnit}. Zeitraum: ${t} ${timeUnit}.`; break;
                        case 'W0': questionText = `Nach ${t} ${timeUnit} ist die ${valWord} auf ${wn_f} ${unit} gesunken. Die Halbwertszeit betrÃ¤gt ${thalf} ${timeUnit}.`; break;
                        case 't': questionText = `Startwert: ${w0_f} ${unit}. Endwert: ${wn_f} ${unit}. Die Halbwertszeit betrÃ¤gt ${thalf} ${timeUnit}.`; break;
                    }
                }
                questionText += " Was musst du berechnen?";

                let explanation = `Gegeben:\n${type !== 'W0' ? `W0 = ${w0_f} ${unit}\n` : ''}${type !== 'Wn' ? `Wn = ${wn_f} ${unit}\n` : ''}${type !== 't' ? `t = ${t} ${timeUnit}\n` : ''}Halbwertszeit Tâ‚/â‚‚ = ${thalf} ${timeUnit}  => q = 0,5\n\nRechnung:\n`;
                if (type === 'Wn') explanation += `Wn = ${w0_f} Â· 0,5^(${t}/${thalf}) = ${wn_f}`;
                if (type === 'W0') explanation += `W0 = ${wn_f} / 0,5^(${t}/${thalf}) = ${w0_f}`;
                if (type === 't') explanation += `t = ( log(${wn_f}/${w0_f}) / log(0,5) ) Â· ${thalf} = ${t}`;

                setProblem({ type, scenario, text: questionText, w0, wn, q, t, thalf, unit, solution: type === 't' ? t : (type === 'W0' ? w0 : wn), explanation });
                
                let opts = [];
                switch (type) {
                    case 'Wn': opts = [{ id: '1', label: 'Formel ist bereits aufgelÃ¶st. Einfach ausrechnen.', isCorrect: true }, { id: '2', label: <span>Teile durch <VarW0/></span>, isCorrect: false }, { id: '3', label: <span>Wende den Logarithmus an</span>, isCorrect: false }]; break;
                    case 'W0': opts = [{ id: '1', label: <span>Teile durch 0,5<sup>t/T<sub>1/2</sub></sup></span>, isCorrect: true }, { id: '2', label: <span>Multipliziere mit 0,5<sup>t/T<sub>1/2</sub></sup></span>, isCorrect: false }, { id: '3', label: <span>Teile durch t</span>, isCorrect: false }]; break;
                    case 't': opts = [{ id: '1', label: <span>1. Teile durch <VarW0/> <br/> 2. Logarithmus anwenden<br/> 3. Mit T<sub>1/2</sub> multiplizieren</span>, isCorrect: true }, { id: '2', label: <span>1. Teile durch 0,5 <br/> 2. Logarithmus anwenden</span>, isCorrect: false }, { id: '3', label: <span>1. Teile durch <VarW0/> <br/> 2. Ziehe die Wurzel</span>, isCorrect: false }]; break;
                }
                setOptions(opts.sort(() => Math.random() - 0.5)); setLoading(false);
            };

            useEffect(() => { generateProblem(); }, [difficulty]);

            const handleDifficultyChange = (newDiff) => {
                if (difficulty === newDiff) generateProblem(); else setDifficulty(newDiff);
            };

            const handleIdentify = (selected) => {
                if (step > 1 || !problem) return;
                setSelectedIdentification(selected);
                if (selected === problem.type) { setTimeout(() => advance(2), 600); } else { triggerError(); }
            };

            const checkFormulaInputs = () => {
                if (!problem) return;
                let allCorrect = true, feedback = {};
                const checkVal = (input, target) => { const val = parseFloat(input.replace(',', '.')); if (isNaN(val)) return false; return Math.abs(val - target) < (Math.max(target * 0.01, 0.005)); };
                if (problem.type !== 'Wn' && !checkVal(inputs.wn, problem.wn)) { feedback.wn = 'incorrect'; allCorrect = false; } else feedback.wn = 'correct';
                if (problem.type !== 'W0' && !checkVal(inputs.w0, problem.w0)) { feedback.w0 = 'incorrect'; allCorrect = false; } else feedback.w0 = 'correct';
                if (problem.type !== 't' && !checkVal(inputs.t, problem.t)) { feedback.t = 'incorrect'; allCorrect = false; } else feedback.t = 'correct';
                if (!checkVal(inputs.thalf, problem.thalf)) { feedback.thalf = 'incorrect'; allCorrect = false; } else feedback.thalf = 'correct';
                setInputFeedback(feedback); 
                if (allCorrect) advance(3); else triggerError();
            };

            const handleOptionSelect = (opt) => {
                if (step > 3) return;
                setSelectedOptionId(opt.id);
                if (opt.isCorrect) { setTimeout(() => advance(4), 600); } else { triggerError(); }
            };

            const checkFinalResult = () => {
                if (!problem) return;
                const val = parseFloat(finalAnswer.replace(',', '.')); if (isNaN(val)) return;
                const tolerance = problem.type === 't' ? 0.5 : (problem.solution * 0.01);
                if (Math.abs(val - problem.solution) <= tolerance || (problem.type === 't' && Math.round(val) === problem.solution)) {
                    setFinalFeedback('correct'); 
                    const newStreak = streak + 1;
                    setStreak(newStreak);
                    if (newStreak > 0 && newStreak % 3 === 0) triggerCelebration(setShowAnim);
                    setShowSolution(true); advance(5);
                } else { setFinalFeedback('incorrect'); triggerError(); }
            };

            return (
                <div className="page-transition max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    {showAnim && <CelebrationOverlay />}
                    <header className="bg-rose-600 text-rose-50 shadow-md p-6 rounded-xl mb-6">
                        <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div className="flex items-center space-x-3">
                                <TrendingDown size={32} />
                                <div>
                                    <h1 className="text-2xl font-bold tracking-tight text-white flex items-center">Halbwertszeit <span className="hidden sm:inline text-rose-200 text-lg font-normal border-l-2 border-rose-400 pl-2 ml-2">10. Klasse</span></h1>
                                </div>
                            </div>
                            <div className="bg-rose-700 px-4 py-1.5 rounded-full text-sm font-bold shadow-sm flex items-center">
                                <TrendingDown className="w-4 h-4 mr-2 text-rose-300" /> Streak: {streak}
                            </div>
                        </div>
                    </header>

                    <div className="flex flex-col sm:flex-row items-center justify-center gap-3 mb-6 bg-white p-3 rounded-xl shadow-sm border border-slate-200">
                        <span className="font-bold text-slate-700">Neue Aufgabe generieren:</span>
                        <div className="flex gap-2">
                            <button onClick={() => handleDifficultyChange('normal')} className={`px-4 py-2 font-bold rounded-lg shadow-sm transition-colors ${difficulty === 'normal' ? 'bg-rose-600 text-white' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'}`}>Normal</button>
                            <button onClick={() => handleDifficultyChange('schwer')} className={`px-4 py-2 font-bold rounded-lg shadow-sm transition-colors ${difficulty === 'schwer' ? 'bg-rose-600 text-white' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'}`}>Schwer</button>
                        </div>
                    </div>

                    <main className="space-y-6 relative">
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="bg-rose-50 px-6 py-3 border-b border-rose-200 flex justify-between items-center">
                                <h2 className="font-semibold text-rose-900 flex items-center"><BookOpen size={18} className="mr-2"/> Sachaufgabe</h2>
                                <span className="text-xs font-bold px-2 py-1 rounded uppercase tracking-wider bg-rose-200 text-rose-800">Halbwertszeit</span>
                            </div>
                            <div className="p-6 bg-white min-h-[100px] flex items-center justify-center text-center">
                                {loading ? <RefreshCw className="w-8 h-8 animate-spin text-rose-400"/> : <p className="text-xl font-medium leading-relaxed">{problem?.text}</p>}
                            </div>
                        </div>

                        <div className="space-y-4">
                            <StepCard title="1. Was ist gesucht?" stepNum={1} currentStep={step} theme="rose">
                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                    {[{ type: 'Wn', label: <VarWn/>, desc: "Endwert" }, { type: 'W0', label: <VarW0/>, desc: "Anfangswert" }, { type: 't', label: <span className="font-serif italic text-xl">t</span>, desc: "Dauer / Zeit" }].map((item) => (
                                        <button key={item.type} onClick={() => handleIdentify(item.type)} disabled={step > 1} className={`p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-1 ${selectedIdentification === item.type ? (item.type === problem?.type ? 'border-green-500 bg-green-50 text-green-900 font-bold' : 'border-red-400 bg-red-50 text-red-900') : 'border-slate-200 hover:border-rose-300 bg-white'}`}>
                                            <span className="text-xl font-serif font-bold">{item.label}</span><span className="text-[10px] sm:text-xs uppercase font-semibold text-slate-500">{item.desc}</span>
                                        </button>
                                    ))}
                                </div>
                                {step === 1 && <TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text="Achte darauf, ob der Startwert, der Endwert oder die Dauer gefragt ist. q ist bei Halbwertszeit immer 0,5." />}
                                {step > 1 && <SuccessMark text={`Richtig! Du suchst ${problem?.type === 'Wn' ? "Wn" : problem?.type === 'W0' ? "W0" : "t (Dauer)"}.`} />}
                            </StepCard>

                            {step >= 2 && (
                                <StepCard title="2. Werte einsetzen (Halbwertszeit)" stepNum={2} currentStep={step} theme="rose">
                                    <div className="flex flex-wrap items-center justify-center gap-2 md:gap-4 bg-slate-50 p-4 sm:p-6 rounded-xl border border-dashed border-slate-300">
                                        <FormulaInput id="wn" label={<VarWn/>} value={inputs.wn} theme="rose" isUnknown={problem.type === 'Wn'} status={inputFeedback.wn} disabled={step > 2 || inputFeedback.wn === 'correct'} onChange={handleInputChange} />
                                        <span className="text-2xl text-slate-400 font-bold mt-6">=</span>
                                        <FormulaInput id="w0" label={<VarW0/>} value={inputs.w0} theme="rose" isUnknown={problem.type === 'W0'} status={inputFeedback.w0} disabled={step > 2 || inputFeedback.w0 === 'correct'} onChange={handleInputChange} />
                                        <span className="text-2xl text-slate-400 font-bold mt-6">Â·</span>
                                        
                                        <div className="flex items-start mt-6">
                                            <div className="flex flex-col items-center">
                                                <div className="w-16 h-12 flex items-center justify-center font-bold text-xl text-rose-800 bg-rose-100 border-2 border-rose-300 rounded-lg">0,5</div>
                                            </div>
                                            <div className="flex flex-col items-center ml-1" style={{marginTop: '-24px'}}>
                                                <div className="flex items-center gap-1">
                                                    <span className="text-slate-500 italic text-sm">t</span>
                                                    <MiniFormulaInput id="t" value={inputs.t} isUnknown={problem.type === 't'} status={inputFeedback.t} disabled={step > 2 || inputFeedback.t === 'correct'} onChange={handleInputChange} />
                                                </div>
                                                <div className="w-full border-b-2 border-slate-400 my-1"></div>
                                                <div className="flex items-center gap-1">
                                                    <span className="text-slate-500 italic text-sm">T<sub>1/2</sub></span>
                                                    <MiniFormulaInput id="thalf" value={inputs.thalf} isUnknown={false} status={inputFeedback.thalf} disabled={step > 2 || inputFeedback.thalf === 'correct'} onChange={handleInputChange} />
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    {step === 2 && <div className="mt-4 flex justify-between items-center"><TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text="Der Exponent ist ein Bruch: Oben die gesamte Dauer (t), unten die Halbwertszeit (T1/2)." /><SubmitBtn onClick={checkFormulaInputs} theme="rose" /></div>}
                                    {step > 2 && <SuccessMark text="Alle Werte richtig eingesetzt!" />}
                                </StepCard>
                            )}

                            {step >= 3 && (
                                <StepCard title="3. Gleichung umformen" stepNum={3} currentStep={step} theme="rose">
                                    <div className="flex justify-center items-center gap-2 text-xl md:text-2xl font-mono bg-slate-100 py-4 px-2 rounded-lg mb-6 text-slate-700">
                                        <span>{problem.type === 'Wn' ? <span className="text-rose-600 font-bold">Wn</span> : formatNum(problem.wn)} = {problem.type === 'W0' ? <span className="text-rose-600 font-bold">W0</span> : formatNum(problem.w0)} Â· 0,5<sup className="ml-1"><span className="inline-flex flex-col items-center align-middle text-[0.6em]"><span className="border-b border-slate-700 pb-0.5 px-1">{problem.type === 't' ? <span className="text-rose-600 font-bold">t</span> : problem.t}</span><span className="pt-0.5 px-1">{problem.thalf}</span></span></sup></span>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                        {options.map((opt) => (
                                            <button key={opt.id} onClick={() => handleOptionSelect(opt)} disabled={step > 3} className={`p-4 rounded-xl border-2 text-sm md:text-base font-medium flex flex-col items-center justify-center gap-2 ${selectedOptionId === opt.id ? (opt.isCorrect ? 'border-green-500 bg-green-50 text-green-900 font-bold' : 'border-red-400 bg-red-50 text-red-900') : 'border-slate-200 hover:border-rose-300'}`}>
                                                {opt.label}
                                            </button>
                                        ))}
                                    </div>
                                    {step === 3 && <TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text="Um W0 zu erhalten, musst du durch die Potenz 0,5^(t/T1/2) teilen. FÃ¼r t brauchst du den Logarithmus." />}
                                    {step > 3 && <SuccessMark text="Richtig umgeformt!" />}
                                </StepCard>
                            )}

                            {step >= 4 && (
                                <StepCard title="4. Ergebnis berechnen" stepNum={4} currentStep={step} theme="rose">
                                    <div className="flex flex-col sm:flex-row gap-4 items-center w-full">
                                        <div className="relative flex-grow max-w-sm w-full">
                                            <span className="absolute left-4 top-1/2 -translate-y-1/2 font-serif text-slate-400 italic">{problem.type === 'Wn' ? <VarWn/> : problem.type === 'W0' ? <VarW0/> : <span className="font-serif italic text-xl">t</span>} =</span>
                                            <input type="text" value={finalAnswer} onChange={(e) => setFinalAnswer(e.target.value.replace('.', ','))} disabled={step === 5} placeholder="Rechner nutzen..." className={`pl-16 pr-12 py-3 w-full rounded-lg border-2 text-lg outline-none transition-colors shadow-sm ${finalFeedback === 'correct' ? 'border-green-500 bg-green-50 text-green-900 font-bold' : finalFeedback === 'incorrect' ? 'border-red-400 bg-red-50' : 'border-slate-300 focus:border-rose-500'}`} />
                                            <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm font-medium">{problem.type === 't' ? '' : problem.unit}</span>
                                        </div>
                                        {step === 4 && <SubmitBtn onClick={checkFinalResult} theme="rose" />}
                                    </div>
                                    {step === 4 && <TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text="Nutze den Rechner! Wenn t gesucht ist: log(Endwert / Startwert) geteilt durch log(0.5), dann mal die Halbwertszeit!" />}
                                    {step > 4 && <SuccessMark text="Perfekt gerechnet!" />}
                                </StepCard>
                            )}

                            {step === 5 && (
                                <div className="bg-green-50 border-2 border-green-500 p-8 rounded-xl shadow-sm text-center animate-fade-in mt-6">
                                    <h3 className="text-3xl font-bold text-green-800 mb-3">Klasse gemacht! ðŸŽ‰</h3>
                                    <div className="flex flex-col sm:flex-row justify-center gap-4 mt-6">
                                        <button onClick={() => setShowSolution(!showSolution)} className="text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-medium shadow-sm"><BookOpen className="w-4 h-4"/> LÃ¶sungsweg</button>
                                        <button onClick={generateProblem} className="bg-rose-600 hover:bg-rose-700 text-white px-8 py-3 rounded-lg font-bold shadow-md flex items-center justify-center gap-2"><RefreshCw className="w-5 h-5" /> NÃ¤chste Aufgabe</button>
                                    </div>
                                    {showSolution && <div className="w-full bg-white p-6 rounded-xl border border-green-200 mt-6 text-sm font-mono whitespace-pre-line text-slate-700 text-left shadow-inner">{problem.explanation}</div>}
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        // ==========================================
        // 4. BRUCHGLEICHUNGSTRAINER
        // ==========================================
        const normalizeString = (str) => { if (!str) return ""; return str.toString().toLowerCase().replace(/\s+/g, '').replace(/,/g, '.').replace(/x2/g, 'x^2').replace(/(^|[\+\-\=\(])1x/g, '$1x'); };
        const formatDe = (numStr) => numStr.toString().replace(/\./g, ',');
        const checkMultiInput = (inputs, expectedArr) => {
            const normInputs = inputs.map(normalizeString).filter(s => s !== ""); const normExpected = expectedArr.map(normalizeString);
            if (normInputs.length !== normExpected.length) return false;
            const remaining = [...normExpected];
            for (let val of normInputs) { const idx = remaining.indexOf(val); if (idx === -1) return false; remaining.splice(idx, 1); }
            return true;
        };

        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const formatTerm = (coef, isFirst=false, variable="") => {
            if (coef === 0) return "";
            let abs = Math.abs(coef); let sign = coef > 0 ? (isFirst ? "" : "+") : "-"; let val = (abs === 1 && variable !== "") ? variable : abs + variable;
            return sign + val;
        };

        const generateTemplate1 = () => { // Leicht
            while(true) {
                let x1 = getRandomInt(-6, 6) || 1; let x2 = getRandomInt(-6, 6) || 2;
                if (x1 === x2 || x1 + x2 === 0) continue; 
                let p = -(x1 + x2); let q = x1 * x2;
                let C = getRandomInt(2, 4); let x_def = getRandomInt(1, 5);
                if (x1 === x_def || x2 === x_def || x_def === 0 || x1 === 0 || x2 === 0) continue;
                let D = -C * x_def; let A = D - C * p; let B = -C * q;
                if (A === 0) continue; 
                let topStr = `${formatTerm(A, true, 'x')} ${formatTerm(B)}`.trim();
                let botStr = `${C}x ${formatTerm(D)}`; let multLeft = `${formatTerm(A, true, 'x')}${formatTerm(B)}`; if (multLeft.startsWith('+')) multLeft = multLeft.substring(1);
                return {
                    id: Math.random(), diff: "Leicht", renderEquation: () => <div className="flex items-center text-xl font-math"><Frac top={topStr} bot={botStr} /><span className="mx-2">=</span><span>x</span></div>,
                    steps: {
                        def: { expected: [x_def.toString()], inputs: 1 }, hn: { expected: [`${C}x${formatTerm(D)}`, `${C}*(x-${x_def})`, `${C}(x-${x_def})`] }, multLeft: { expected: [multLeft] }, multRight: { expected: [`${C}x^2${formatTerm(D, false, 'x')}`, `x(${botStr})`] }, zusammen: { expected: [`x^2${formatTerm(p, false, 'x')}${formatTerm(q)}=0`, `0=x^2${formatTerm(p, false, 'x')}${formatTerm(q)}`] }, pq_p: { expected: [p.toString()] }, pq_q: { expected: [q.toString()] }, pq_x1x2: { expected: [x1.toString(), x2.toString()], inputs: 2 }, lm: { expected: [x1.toString(), x2.toString()], inputs: 2 }
                    }
                };
            }
        };

        const generateTemplate2 = () => { // Mittel
            while(true) {
                let A = getRandomInt(-8, 8); let B = getRandomInt(-8, 8); let C = getRandomInt(1, 6);
                if (A===0 || B===0 || A+B+C===0) continue;
                let p = -(A+B+C); let q = A*C; let D_disc = p*p/4 - q;
                if (D_disc >= 0 && Number.isInteger(Math.sqrt(D_disc))) {
                    let rootD = Math.sqrt(D_disc); let x1 = -p/2 + rootD; let x2 = -p/2 - rootD;
                    if (Number.isInteger(x1) && Number.isInteger(x2) && x1 !== 0 && x2 !== 0 && x1 !== C && x2 !== C && x1 !== x2) {
                        let bot2Str = `x ${formatTerm(-C)}`; let multLeft1 = `${A}(x${formatTerm(-C)})`; let multLeft2 = `${B > 0 ? '+' : ''}${B}x`;
                        return {
                            id: Math.random(), diff: "Mittel", renderEquation: () => <div className="flex items-center text-xl font-math"><Frac top={A} bot="x" /><span className="mx-2">{B > 0 ? '+' : '-'}</span><Frac top={Math.abs(B)} bot={bot2Str} /><span className="mx-2">=</span><span>1</span></div>,
                            steps: {
                                def: { expected: ["0", C.toString()], inputs: 2 }, hn: { expected: [`x(x-${C})`, `x*(x-${C})`, `x^2-${C}x`] }, multLeft: { expected: [`${multLeft1}${multLeft2}`, `${A}x${formatTerm(-A*C)}${multLeft2}`, `${formatTerm(A+B, true, 'x')}${formatTerm(-A*C)}`] }, multRight: { expected: [`x^2${formatTerm(-C, false, 'x')}`, `x(x-${C})`] }, zusammen: { expected: [`x^2${formatTerm(p, false, 'x')}${formatTerm(q)}=0`, `0=x^2${formatTerm(p, false, 'x')}${formatTerm(q)}`] }, pq_p: { expected: [p.toString()] }, pq_q: { expected: [q.toString()] }, pq_x1x2: { expected: [x1.toString(), x2.toString()], inputs: 2 }, lm: { expected: [x1.toString(), x2.toString()], inputs: 2 }
                            }
                        };
                    }
                }
            }
        };

        const generateTemplate3 = () => { // Schwer
            while(true) {
                let A = getRandomInt(-6, 6); let B = getRandomInt(-6, 6); let C = getRandomInt(1, 5);
                if (A===0 || B===0 || A+B===0) continue;
                let p = -(A+B); let q = C * (A - B - C); let D_disc = p*p/4 - q;
                if (D_disc >= 0 && Number.isInteger(Math.sqrt(D_disc))) {
                    let rootD = Math.sqrt(D_disc); let x1 = -p/2 + rootD; let x2 = -p/2 - rootD;
                    if (Number.isInteger(x1) && Number.isInteger(x2) && x1 !== C && x2 !== C && x1 !== -C && x2 !== -C && x1 !== x2) {
                        let term1 = `${A}(x${formatTerm(-C)})`; let term2 = `${B > 0 ? '+' : ''}${B}(x${formatTerm(C)})`;
                        return {
                            id: Math.random(), diff: "Schwer", renderEquation: () => <div className="flex items-center text-xl font-math"><Frac top={A} bot={`x ${formatTerm(C)}`} /><span className="mx-2">{B > 0 ? '+' : '-'}</span><Frac top={Math.abs(B)} bot={`x ${formatTerm(-C)}`} /><span className="mx-2">=</span><span>1</span></div>,
                            steps: {
                                def: { expected: [(-C).toString(), C.toString()], inputs: 2 }, hn: { expected: [`(x+${C})(x-${C})`, `x^2-${C*C}`, `(x-${C})(x+${C})`] }, multLeft: { expected: [`${term1}${term2}`, `${A}x${formatTerm(-A*C)}${formatTerm(B, false, 'x')}${formatTerm(B*C)}`, `${formatTerm(A+B, true, 'x')}${formatTerm(-A*C + B*C)}`] }, multRight: { expected: [`x^2-${C*C}`, `(x+${C})(x-${C})`] }, zusammen: { expected: [`x^2${formatTerm(p, false, 'x')}${formatTerm(q)}=0`, `0=x^2${formatTerm(p, false, 'x')}${formatTerm(q)}`] }, pq_p: { expected: [p.toString()] }, pq_q: { expected: [q.toString()] }, pq_x1x2: { expected: [x1.toString(), x2.toString()], inputs: 2 }, lm: { expected: [x1.toString(), x2.toString()], inputs: 2 }
                            }
                        };
                    }
                }
            }
        };

        const hardcodedProblems = [
            { id: 1, diff: "PrÃ¼fung 2018 I", renderEquation: () => <div className="flex items-center text-xl font-math"><Frac top="8x + 39" bot="4x - 12" /><span className="mx-2">=</span><span>x</span></div>, steps: { def: { expected: ["3"], inputs: 1 }, hn: { expected: ["4x-12", "4(x-3)", "4*(x-3)", "(4x-12)"] }, multLeft: { expected: ["8x+39"] }, multRight: { expected: ["4x^2-12x", "x(4x-12)", "x*(4x-12)"] }, zusammen: { expected: ["x^2-5x-9.75=0", "x^2-5x-39/4=0", "0=x^2-5x-9.75"] }, pq_p: { expected: ["-5"] }, pq_q: { expected: ["-9.75", "-39/4"] }, pq_x1x2: { expected: ["6.5", "-1.5"], inputs: 2 }, lm: { expected: ["6.5", "-1.5"], inputs: 2 } } },
            { id: 2, diff: "PrÃ¼fung 2018 II", renderEquation: () => <div className="flex items-center text-xl font-math"><Frac top="x" bot="2" /><span className="mx-2">+</span><Frac top="x" bot="x - 3" /><span className="mx-2">=</span><Frac top="3" bot="x - 3" /><span className="mx-2">- 2</span></div>, steps: { def: { expected: ["3"], inputs: 1 }, hn: { expected: ["2(x-3)", "2*(x-3)", "2x-6"] }, multLeft: { expected: ["x^2-x", "x(x-3)+2x", "x^2-3x+2x"] }, multRight: { expected: ["18-4x", "6-4(x-3)", "6-4x+12"] }, zusammen: { expected: ["x^2+3x-18=0", "0=x^2+3x-18"] }, pq_p: { expected: ["3"] }, pq_q: { expected: ["-18"] }, pq_x1x2: { expected: ["3", "-6"], inputs: 2 }, lm: { expected: ["-6"], inputs: 1 } } },
            { id: 3, diff: "PrÃ¼fung 2017 I", renderEquation: () => <div className="flex items-center text-xl font-math"><Frac top="x - 4" bot="6" /><span className="mx-2">+</span><Frac top="4(x - 11)" bot="x - 6" /><span className="mx-2">=</span><Frac top="16 - x" bot="2" /></div>, steps: { def: { expected: ["6"], inputs: 1 }, hn: { expected: ["6(x-6)", "6*(x-6)", "6x-36"] }, multLeft: { expected: ["x^2+14x-240", "(x-4)(x-6)+24(x-11)"] }, multRight: { expected: ["-3x^2+66x-288", "3(x-6)(16-x)"] }, zusammen: { expected: ["x^2-13x+12=0", "0=x^2-13x+12", "4x^2-52x+48=0"] }, pq_p: { expected: ["-13"] }, pq_q: { expected: ["12"] }, pq_x1x2: { expected: ["12", "1"], inputs: 2 }, lm: { expected: ["12", "1"], inputs: 2 } } },
            { id: 4, diff: "PrÃ¼fung 2016 I", renderEquation: () => <div className="flex items-center text-xl font-math"><Frac top="2(x + 2)" bot="x" /><span className="mx-2">=</span><span className="mx-2">2 -</span><Frac top="2 - x" bot="x - 2" /></div>, steps: { def: { expected: ["0", "2"], inputs: 2 }, hn: { expected: ["x(x-2)", "x*(x-2)", "x^2-2x"] }, multLeft: { expected: ["2x^2-8", "2(x+2)(x-2)", "(2x+4)(x-2)"] }, multRight: { expected: ["3x^2-6x", "2x(x-2)-x(2-x)", "2x^2-4x-2x+x^2"] }, zusammen: { expected: ["x^2-6x+8=0", "0=x^2-6x+8"] }, pq_p: { expected: ["-6"] }, pq_q: { expected: ["8"] }, pq_x1x2: { expected: ["4", "2"], inputs: 2 }, lm: { expected: ["4"], inputs: 1 } } }
        ];

        const BruchgleichungsTrainer = () => {
            const [probList, setProbList] = useState([generateTemplate1()]);
            const [currentProblemIdx, setCurrentProblemIdx] = useState(0);
            const [selectedDiff, setSelectedDiff] = useState('leicht');
            
            const [currentStep, setCurrentStep] = useState(1);
            const [errors, setErrors] = useState(0);
            const [errorMsg, setErrorMsg] = useState("");
            const [tipRevealed, setTipRevealed] = useState(false);
            const [showAnim, setShowAnim] = useState(false);
            const [streak, setStreak] = useState(() => getStorage('smarth_streak_brueche', 0));
            
            const [defInputs, setDefInputs] = useState(["", ""]); const [hnInput, setHnInput] = useState(""); const [multLeft, setMultLeft] = useState(""); const [multRight, setMultRight] = useState(""); const [zusInput, setZusInput] = useState(""); const [pqP, setPqP] = useState(""); const [pqQ, setPqQ] = useState(""); const [einsetzenP1, setEinsetzenP1] = useState(""); const [einsetzenP2, setEinsetzenP2] = useState(""); const [einsetzenQ, setEinsetzenQ] = useState(""); const [pqX, setPqX] = useState(["", ""]); const [lmInputs, setLmInputs] = useState(["", ""]);

            useEffect(() => { setStorage('smarth_streak_brueche', streak); }, [streak]);
            const prob = probList[currentProblemIdx];

            const clearForm = () => {
                setCurrentStep(1); setErrors(0); setErrorMsg(""); setTipRevealed(false);
                setDefInputs(["", ""]); setHnInput(""); setMultLeft(""); setMultRight(""); setZusInput(""); setPqP(""); setPqQ(""); setEinsetzenP1(""); setEinsetzenP2(""); setEinsetzenQ(""); setPqX(["", ""]); setLmInputs(["", ""]);
            };

            const changeDifficulty = (diff) => {
                setSelectedDiff(diff); clearForm();
                if (diff === 'leicht') setProbList([generateTemplate1()]);
                else if (diff === 'mittel') setProbList([generateTemplate2()]);
                else if (diff === 'schwer') setProbList([generateTemplate3()]);
                else if (diff === 'pruefung') {
                    if (selectedDiff === 'pruefung') {
                        setCurrentProblemIdx((prev) => (prev + 1) % hardcodedProblems.length);
                        return;
                    } else {
                        setProbList(hardcodedProblems); setCurrentProblemIdx(0);
                    }
                }
                if(diff !== 'pruefung') setCurrentProblemIdx(0);
            };

            const handleNextPruefung = () => { setCurrentProblemIdx((prev) => (prev + 1) % hardcodedProblems.length); clearForm(); };
            const handleError = (msg) => { setErrorMsg(msg); setErrors(prev => prev + 1); setStreak(0); };
            const advanceStep = () => { 
                const nextStep = currentStep + 1;
                setCurrentStep(nextStep); setErrors(0); setErrorMsg(""); setTipRevealed(false); 
                if (nextStep > 8) {
                    setStreak(s => s + 1);
                    triggerCelebration(setShowAnim);
                }
            };

            const validateStep1 = () => { const inputs = defInputs.slice(0, prob.steps.def.inputs); if (checkMultiInput(inputs, prob.steps.def.expected)) advanceStep(); else handleError("Die Definitionsmenge ist nicht ganz richtig."); };
            const validateStep2 = () => { if (prob.steps.hn.expected.map(normalizeString).includes(normalizeString(hnInput))) advanceStep(); else handleError("Der Hauptnenner stimmt nicht."); };
            const validateStep3 = () => { const leftOk = prob.steps.multLeft.expected.map(normalizeString).includes(normalizeString(multLeft)); const rightOk = prob.steps.multRight.expected.map(normalizeString).includes(normalizeString(multRight)); if (leftOk && rightOk) advanceStep(); else handleError("Beim Durchmultiplizieren ist ein Fehler passiert."); };
            const validateStep4 = () => { if (prob.steps.zusammen.expected.map(normalizeString).includes(normalizeString(zusInput))) advanceStep(); else handleError("Die Normalform ist nicht korrekt."); };
            const validateStep5 = () => { const pOk = normalizeString(pqP) === normalizeString(prob.steps.pq_p.expected[0]); const qOk = normalizeString(pqQ) === normalizeString(prob.steps.pq_q.expected[0]); if (pOk && qOk) advanceStep(); else handleError("p oder q ist falsch abgelesen."); };
            const validateStep6 = () => { const pExp = normalizeString(prob.steps.pq_p.expected[0]); const qExp = normalizeString(prob.steps.pq_q.expected[0]); if (normalizeString(einsetzenP1) === pExp && normalizeString(einsetzenP2) === pExp && normalizeString(einsetzenQ) === qExp) advanceStep(); else handleError("Nicht richtig eingesetzt (Vorzeichen beachten!)."); };
            const validateStep7 = () => { const inputs = pqX.slice(0, prob.steps.pq_x1x2.inputs); if (checkMultiInput(inputs, prob.steps.pq_x1x2.expected)) advanceStep(); else handleError("Das Ergebnis der pq-Formel stimmt nicht."); };
            const validateStep8 = () => { const inputs = lmInputs.slice(0, prob.steps.lm.inputs); if (checkMultiInput(inputs, prob.steps.lm.expected)) advanceStep(); else handleError("Vergleiche deine Ergebnisse aus Schritt 7 mit D aus Schritt 1."); };

            const inputStyle = (stepNum, wClass="w-16") => `border-2 rounded p-2 text-center focus:outline-none transition-colors ${wClass} ${currentStep > stepNum ? 'border-green-500 bg-green-50 text-green-900 font-bold shadow-sm' : 'border-slate-300 focus:border-amber-500 bg-white shadow-inner'}`;

            return (
                <div className="page-transition max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    {showAnim && <CelebrationOverlay />}
                    <header className="bg-amber-500 text-amber-950 shadow-md p-6 rounded-xl mb-6">
                        <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div className="flex items-center space-x-3">
                                <FractionIcon className="w-8 h-8" />
                                <h1 className="text-2xl font-bold tracking-tight">Bruchgleichungen <span className="hidden sm:inline text-amber-800 text-lg font-normal border-l-2 border-amber-600 pl-2 ml-2">10. Klasse</span></h1>
                            </div>
                            <div className="bg-amber-100 px-4 py-1.5 rounded-full text-sm font-bold shadow-sm">Streak: {streak}</div>
                        </div>
                    </header>

                    <div className="flex flex-col sm:flex-row items-center justify-center gap-3 mb-6 bg-white p-3 rounded-xl shadow-sm border border-slate-200">
                        <span className="font-bold text-slate-700">Neue Aufgabe generieren:</span>
                        <div className="flex gap-2 flex-wrap justify-center">
                            {['leicht', 'mittel', 'schwer', 'pruefung'].map(d => (
                                <button key={d} onClick={() => changeDifficulty(d)} className={`px-4 py-2 font-bold rounded-lg shadow-sm transition-colors ${selectedDiff === d ? 'bg-amber-600 text-white' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'}`}>
                                    {d === 'pruefung' ? 'PrÃ¼fungsaufgaben' : d.charAt(0).toUpperCase() + d.slice(1)}
                                </button>
                            ))}
                        </div>
                    </div>

                    <main className="space-y-6 relative">
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="bg-amber-50 px-6 py-3 border-b border-amber-200 flex justify-between items-center">
                                <h2 className="font-semibold text-amber-900 flex items-center"><BookOpen size={18} className="mr-2"/> Gegebene Gleichung</h2>
                                <span className="text-xs font-bold px-2 py-1 rounded uppercase tracking-wider bg-amber-200 text-amber-800">{prob.diff}</span>
                            </div>
                            <div className="p-8 flex justify-center bg-white overflow-x-auto min-h-[120px] items-center">{prob.renderEquation()}</div>
                        </div>

                        <div className="space-y-4">
                            <StepCard title="1. Definitionsmenge bestimmen" stepNum={1} currentStep={currentStep} theme="amber">
                                <div className="flex items-center space-x-3 mb-2">
                                    <span className="font-semibold text-lg">D = â„ \ {'{'}</span>
                                    <input type="text" value={defInputs[0]} onChange={e => setDefInputs([e.target.value, defInputs[1]])} className={inputStyle(1)} disabled={currentStep !== 1} />
                                    {prob.steps.def.inputs === 2 && (<><span className="font-semibold">;</span><input type="text" value={defInputs[1]} onChange={e => setDefInputs([defInputs[0], e.target.value])} className={inputStyle(1)} disabled={currentStep !== 1} /></>)}
                                    <span className="font-semibold text-lg">{'}'}</span>
                                    {currentStep === 1 && <SubmitBtn onClick={validateStep1} theme="amber" />}
                                </div>
                                {currentStep === 1 && <TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text={`Setze die Nenner gleich 0. LÃ¶sung: ${prob.steps.def.expected.map(formatDe).join(' und ')}`} />}
                                {currentStep > 1 && <SuccessMark text={`D = â„ \\ { ${prob.steps.def.expected.map(formatDe).join('; ')} }`} />}
                            </StepCard>

                            {currentStep >= 2 && (
                                <StepCard title="2. Hauptnenner (HN) finden" stepNum={2} currentStep={currentStep} theme="amber">
                                    <div className="flex items-center space-x-3 mb-2">
                                        <span className="font-semibold">HN =</span>
                                        <input type="text" value={hnInput} onChange={e => setHnInput(e.target.value)} placeholder="z.B. x(x-3)" className={inputStyle(2, "w-64")} disabled={currentStep !== 2} />
                                        {currentStep === 2 && <SubmitBtn onClick={validateStep2} theme="amber" />}
                                    </div>
                                    {currentStep === 2 && <TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text={`Suche den kleinsten gemeinsamen Nenner. LÃ¶sung: ${formatDe(prob.steps.hn.expected[0])}`} />}
                                    {currentStep > 2 && <SuccessMark text={`HN = ${formatDe(prob.steps.hn.expected[0])}`} />}
                                </StepCard>
                            )}

                            {currentStep >= 3 && (
                                <StepCard title="3. Mit dem Hauptnenner durchmultiplizieren" stepNum={3} currentStep={currentStep} theme="amber">
                                    <div className="flex flex-wrap items-center gap-3 mb-2">
                                        <input type="text" value={multLeft} onChange={e => setMultLeft(e.target.value)} placeholder="Linke Seite" className={inputStyle(3, "w-64")} disabled={currentStep !== 3} />
                                        <span className="font-bold text-xl">=</span>
                                        <input type="text" value={multRight} onChange={e => setMultRight(e.target.value)} placeholder="Rechte Seite" className={inputStyle(3, "w-64")} disabled={currentStep !== 3} />
                                        {currentStep === 3 && <SubmitBtn onClick={validateStep3} theme="amber" />}
                                    </div>
                                    {currentStep === 3 && <TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text={`Multipliziere jeden Bruch mit dem HN (KÃ¼rzen!). LÃ¶sung: ${formatDe(prob.steps.multLeft.expected[0])} = ${formatDe(prob.steps.multRight.expected[0])}`} />}
                                    {currentStep > 3 && <SuccessMark text={`${formatDe(prob.steps.multLeft.expected[0])} = ${formatDe(prob.steps.multRight.expected[0])}`} />}
                                </StepCard>
                            )}

                            {currentStep >= 4 && (
                                <StepCard title="4. Zusammenfassen (Normalform)" stepNum={4} currentStep={currentStep} theme="amber">
                                    <div className="flex items-center space-x-3 mb-2">
                                        <input type="text" value={zusInput} onChange={e => setZusInput(e.target.value)} placeholder="z.B. x^2+x-12=0" className={inputStyle(4, "w-64 font-mono")} disabled={currentStep !== 4} />
                                        {currentStep === 4 && <SubmitBtn onClick={validateStep4} theme="amber" />}
                                    </div>
                                    {currentStep === 4 && <TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text={`Bringe alles auf eine Seite und teile, falls nÃ¶tig, bis xÂ² alleine steht. LÃ¶sung: ${formatDe(prob.steps.zusammen.expected[0])}`} />}
                                    {currentStep > 4 && <SuccessMark text={formatDe(prob.steps.zusammen.expected[0])} />}
                                </StepCard>
                            )}

                            {currentStep >= 5 && (
                                <StepCard title="5. Werte fÃ¼r die pq-Formel ablesen" stepNum={5} currentStep={currentStep} theme="amber">
                                    <div className="flex items-center space-x-6 mb-2">
                                        <div className="flex items-center space-x-2"><span className="font-semibold text-lg italic">p =</span><input type="text" value={pqP} onChange={e => setPqP(e.target.value)} className={inputStyle(5, "w-20")} disabled={currentStep !== 5} /></div>
                                        <div className="flex items-center space-x-2"><span className="font-semibold text-lg italic">q =</span><input type="text" value={pqQ} onChange={e => setPqQ(e.target.value)} className={inputStyle(5, "w-20")} disabled={currentStep !== 5} /></div>
                                        {currentStep === 5 && <SubmitBtn onClick={validateStep5} theme="amber" />}
                                    </div>
                                    {currentStep === 5 && <TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text={`p ist die Zahl vor dem x, q ist die Zahl ohne x. Vorzeichen mitnehmen! LÃ¶sung: p=${formatDe(prob.steps.pq_p.expected[0])}, q=${formatDe(prob.steps.pq_q.expected[0])}`} />}
                                    {currentStep > 5 && <SuccessMark text={`p = ${formatDe(prob.steps.pq_p.expected[0])}, q = ${formatDe(prob.steps.pq_q.expected[0])}`} />}
                                </StepCard>
                            )}

                            {currentStep >= 6 && (
                                <StepCard title="6. Werte in die pq-Formel einsetzen" stepNum={6} currentStep={currentStep} theme="amber">
                                    <div className="flex flex-wrap items-center space-x-2 text-xl font-math bg-slate-50 p-4 border border-slate-200 rounded-lg overflow-x-auto mb-2">
                                        <span>xâ‚,â‚‚ = -</span>
                                        <Frac top={<input type="text" value={einsetzenP1} onChange={e=>setEinsetzenP1(e.target.value)} className={inputStyle(6, "w-16")} disabled={currentStep !== 6} placeholder="p" />} bot="2" />
                                        <span className="mx-2">Â±</span>
                                        <span className="text-4xl text-slate-800">âˆš</span>
                                        <div className="border-t-2 border-slate-800 flex items-center pt-1 mt-3 space-x-2">
                                            <span>(</span>
                                            <Frac top={<input type="text" value={einsetzenP2} onChange={e=>setEinsetzenP2(e.target.value)} className={inputStyle(6, "w-16")} disabled={currentStep !== 6} placeholder="p" />} bot="2" />
                                            <span>)Â² - </span>
                                            <input type="text" value={einsetzenQ} onChange={e=>setEinsetzenQ(e.target.value)} className={inputStyle(6, "w-20")} disabled={currentStep !== 6} placeholder="q" />
                                        </div>
                                        {currentStep === 6 && <div className="ml-4"><SubmitBtn onClick={validateStep6} theme="amber" /></div>}
                                    </div>
                                    {currentStep === 6 && <TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text="Setze p und q exakt so ein, wie du sie oben abgelesen hast (inklusive Minuszeichen!)." />}
                                    {currentStep > 6 && <SuccessMark text="Richtig eingesetzt!" />}
                                </StepCard>
                            )}

                            {currentStep >= 7 && (
                                <StepCard title="7. pq-Formel auflÃ¶sen" stepNum={7} currentStep={currentStep} theme="amber">
                                    <div className="flex items-center space-x-6 mb-2">
                                        <div className="flex items-center space-x-2"><span className="font-semibold text-lg">xâ‚ =</span><input type="text" value={pqX[0]} onChange={e => setPqX([e.target.value, pqX[1]])} className={inputStyle(7, "w-20")} disabled={currentStep !== 7} /></div>
                                        {prob.steps.pq_x1x2.inputs === 2 && (
                                            <div className="flex items-center space-x-2"><span className="font-semibold text-lg">xâ‚‚ =</span><input type="text" value={pqX[1]} onChange={e => setPqX([pqX[0], e.target.value])} className={inputStyle(7, "w-20")} disabled={currentStep !== 7} /></div>
                                        )}
                                        {currentStep === 7 && <SubmitBtn onClick={validateStep7} theme="amber" />}
                                    </div>
                                    {currentStep === 7 && <TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text={`Tippe es vorsichtig in den Rechner ein. LÃ¶sung: ${prob.steps.pq_x1x2.expected.map(formatDe).join(' und ')}`} />}
                                    {currentStep > 7 && <SuccessMark text={`x = ${prob.steps.pq_x1x2.expected.map(formatDe).join(' oder x = ')}`} />}
                                </StepCard>
                            )}

                            {currentStep >= 8 && (
                                <StepCard title="8. LÃ¶sungsmenge angeben" stepNum={8} currentStep={currentStep} theme="amber">
                                    {prob.steps.lm.inputs < prob.steps.pq_x1x2.inputs && <strong className="text-red-600 block mb-2">Achtung: Eine LÃ¶sung ist laut Definitionsmenge ungÃ¼ltig!</strong>}
                                    <div className="flex items-center space-x-3 mb-2">
                                        <span className="font-semibold text-lg">L = {'{'}</span>
                                        <input type="text" value={lmInputs[0]} onChange={e => setLmInputs([e.target.value, lmInputs[1]])} className={inputStyle(8, "w-16")} disabled={currentStep !== 8} />
                                        {prob.steps.lm.inputs === 2 && (<><span className="font-semibold">;</span><input type="text" value={lmInputs[1]} onChange={e => setLmInputs([lmInputs[0], e.target.value])} className={inputStyle(8, "w-16")} disabled={currentStep !== 8} /></>)}
                                        <span className="font-semibold text-lg">{'}'}</span>
                                        {currentStep === 8 && <SubmitBtn onClick={validateStep8} theme="amber" />}
                                    </div>
                                    {currentStep === 8 && <TipBox errors={errors} revealed={tipRevealed} setRevealed={setTipRevealed} text={`LÃ¶sung: L = { ${prob.steps.lm.expected.map(formatDe).join('; ')} }`} />}
                                    {currentStep > 8 && <SuccessMark text={`L = { ${prob.steps.lm.expected.map(formatDe).join('; ')} }`} />}
                                </StepCard>
                            )}
                            
                            {errorMsg && currentStep <= 8 && !tipRevealed && (
                                <div className="bg-red-50 border-l-4 border-red-500 p-3 rounded shadow-sm text-red-700 font-medium flex items-center animate-fade-in"><XCircle className="w-5 h-5 mr-2 shrink-0"/>{errorMsg}</div>
                            )}

                            {currentStep > 8 && (
                                <div className="bg-green-50 border-2 border-green-500 p-8 rounded-xl shadow-sm text-center animate-fade-in mt-6">
                                    <h3 className="text-3xl font-bold text-green-800 mb-3">Klasse gemacht! ðŸŽ‰</h3>
                                    <p className="text-green-700 mb-6 text-lg">Du hast die Bruchgleichung vollstÃ¤ndig und richtig gelÃ¶st.</p>
                                    <div className="flex flex-col sm:flex-row justify-center gap-4 mt-6">
                                        {selectedDiff === 'pruefung' && <button onClick={handleNextPruefung} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-md transition-colors flex items-center justify-center"><BookOpen className="mr-2" size={18}/> NÃ¤chste PrÃ¼fung</button>}
                                        <button onClick={() => changeDifficulty(selectedDiff)} className="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2.5 px-6 rounded-lg shadow-md transition-colors flex items-center justify-center"><RefreshCw className="mr-2" size={18}/> NÃ¤chste Aufgabe</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };


        // ==========================================
        // 5. KOPFRECHENTRAINER (Neu, V3: 8 Kategorien + Superscripts)
        // ==========================================
        const shuffleArray = (array) => {
            const newArr = [...array];
            for (let i = newArr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [newArr[i], newArr[j]] = [newArr[j], newArr[i]]; }
            return newArr;
        };

        const fDe = (n) => String(n).replace('.', ','); // Hilfsfunktion fÃ¼r Komma statt Punkt

        const genProzent = (diff) => {
            if (diff === 'leicht') {
                const percent = [10, 20, 25, 50][Math.floor(Math.random()*4)];
                const base = [20, 40, 50, 100, 200][Math.floor(Math.random()*5)];
                const ans = (percent * base) / 100;
                const options = shuffleArray([ans, ans+10, ans-10 > 0 ? ans-10 : ans+5, ans*2].map(n => fDe(n)));
                return { category: 'Prozentrechnung', question: `Berechne ${percent}% von ${base}.`, options, correctAnswer: options.indexOf(fDe(ans)), explanation: `${percent}% ist als Bruch ${percent}/100. Also rechnen wir: ${base} / 100 Â· ${percent} = ${fDe(ans)}.` };
            } else if (diff === 'mittel') {
                const percent = [5, 15, 75][Math.floor(Math.random()*3)];
                const base = [40, 60, 80, 120, 200][Math.floor(Math.random()*5)];
                const ans = (percent * base) / 100;
                const options = shuffleArray([ans, ans+5, ans-5 > 0 ? ans-5 : ans+2, ans*2].map(n => fDe(n)));
                return { category: 'Prozentrechnung', question: `Berechne ${percent}% von ${base}.`, options, correctAnswer: options.indexOf(fDe(ans)), explanation: `Zerlege den Prozentwert im Kopf (z.B. in 10% und 5%). Das Ergebnis ist ${fDe(ans)}.` };
            } else {
                const p = [5, 10, 20, 25][Math.floor(Math.random()*4)];
                const k = [2, 3, 4, 5, 8][Math.floor(Math.random()*5)];
                const W = p * k; const G = 100 * k;
                const options = shuffleArray([G, G/2, G*2, W*10].map(fDe));
                return { category: 'Prozentrechnung', question: `${p}% einer Strecke sind ${W} km. Wie lang ist die gesamte Strecke (100%)?`, options, correctAnswer: options.indexOf(fDe(G)), explanation: `Wenn ${p}% = ${W} km sind, dann teile durch ${p}, um 1% zu erhalten (1% = ${fDe(W/p)} km). 100% sind also 100 Â· ${fDe(W/p)} = ${fDe(G)} km.` };
            }
        };

        const genLinear = (diff) => {
            if (diff === 'leicht') {
                const x = Math.floor(Math.random()*10)+1; const a = Math.floor(Math.random()*4)+2; const b = Math.floor(Math.random()*10)+1; const c = a*x + b;
                const options = shuffleArray([x, x+1, x-1 > 0 ? x-1 : x+2, x+3].map(n => `x = ${n}`));
                return { category: 'Lineare Gleichungen', question: `LÃ¶se im Kopf nach x auf: ${a}x + ${b} = ${c}`, options, correctAnswer: options.indexOf(`x = ${x}`), explanation: `1. Subtrahiere ${b} auf beiden Seiten: ${a}x = ${c-b}. 2. Teile durch ${a}: x = ${x}.` };
            } else if (diff === 'mittel') {
                const a = Math.floor(Math.random()*5)+3; const b = Math.floor(Math.random()*15)+5; const x = Math.floor(Math.random()*8)+2; const c = a*x - b;
                const options = shuffleArray([x, x+1, Math.abs(x-2)||x+2, x+3].map(n => `x = ${n}`));
                return { category: 'Lineare Gleichungen', question: `LÃ¶se im Kopf nach x auf: ${a}x - ${b} = ${c}`, options, correctAnswer: options.indexOf(`x = ${x}`), explanation: `1. Addiere ${b}: ${a}x = ${c+b}. 2. Teile durch ${a}: x = ${x}.` };
            } else {
                const a = Math.floor(Math.random()*4)+3; const c = Math.floor(Math.random()*2)+1; const x = Math.floor(Math.random()*5)+2; const b = Math.floor(Math.random()*5)+1; const d = a*x + b - c*x;
                const correct = `x = ${x}`; const options = shuffleArray([x, x+1, Math.abs(x-1)||x+2, x+3].map(n => `x = ${n}`));
                return { category: 'Lineare Gleichungen', question: `LÃ¶se auf: ${a}x + ${b} = ${c === 1 ? '' : c}x + ${d}`, options, correctAnswer: options.indexOf(correct), explanation: `1. Subtrahiere ${c === 1 ? 'x' : c+'x'}: ${(a-c) === 1 ? 'x' : (a-c)+'x'} + ${b} = ${d}. 2. Subtrahiere ${b}: ${(a-c) === 1 ? 'x' : (a-c)+'x'} = ${d-b}. 3. Teile durch ${a-c}: x = ${x}.` };
            }
        };

        const genBruch = (diff) => {
            if (diff === 'leicht') {
                const v = Math.random();
                if (v > 0.5) {
                    const options = shuffleArray([{el: <Frac top="3" bot="4" />, id: 'c'}, {el: <Frac top="2" bot="6" />, id:'w1'}, {el: <Frac top="1" bot="4" />, id:'w2'}, {el: <Frac top="2" bot="4" />, id:'w3'}]);
                    return { category: 'Bruchrechnen', question: <span className="flex items-center gap-1">Was ergibt <Frac top="1" bot="2" /> + <Frac top="1" bot="4" /> ?</span>, options: options.map(o => o.el), correctAnswer: options.findIndex(o => o.id === 'c'), explanation: <span className="flex items-center gap-1">Erweitere <Frac top="1" bot="2" /> auf Viertel: <Frac top="2" bot="4" />. Dann: <Frac top="2" bot="4" /> + <Frac top="1" bot="4" /> = <Frac top="3" bot="4" />.</span> };
                } else {
                    const options = shuffleArray([{el: <Frac top="1" bot="2" />, id: 'c'}, {el: <Frac top="1" bot="4" />, id:'w1'}, {el: <Frac top="3" bot="4" />, id:'w2'}, {el: <Frac top="1" bot="8" />, id:'w3'}]);
                    return { category: 'Bruchrechnen', question: <span className="flex items-center gap-1">Was ergibt <Frac top="3" bot="4" /> - <Frac top="1" bot="4" /> (gekÃ¼rzt)?</span>, options: options.map(o => o.el), correctAnswer: options.findIndex(o => o.id === 'c'), explanation: <span className="flex items-center gap-1"><Frac top="3" bot="4" /> - <Frac top="1" bot="4" /> = <Frac top="2" bot="4" />. GekÃ¼rzt mit 2 ergibt das <Frac top="1" bot="2" />.</span> };
                }
            } else if (diff === 'mittel') {
                const a = [2, 3][Math.floor(Math.random()*2)]; const b = [4, 5][Math.floor(Math.random()*2)];
                const top = a+b; const bot = a*b;
                const options = shuffleArray([{el: <Frac top={top} bot={bot}/>, id: 'c'}, {el: <Frac top="2" bot={a+b}/>, id:'w1'}, {el: <Frac top={top+1} bot={bot}/>, id:'w2'}, {el: <Frac top={top} bot={a+b}/>, id:'w3'}]);
                return { category: 'Bruchrechnen', question: <span className="flex items-center gap-1">Addiere: <Frac top="1" bot={a} /> + <Frac top="1" bot={b} /></span>, options: options.map(o => o.el), correctAnswer: options.findIndex(o => o.id === 'c'), explanation: <span className="flex items-center gap-1">Bringe beide auf den Hauptnenner {bot}. <Frac top={b} bot={bot} /> + <Frac top={a} bot={bot} /> = <Frac top={top} bot={bot} />.</span> };
            } else {
                const a = 2; const b = 3; const c = 3; const d = 4;
                const options = shuffleArray([{el: <Frac top="1" bot="2" />, id: 'c'}, {el: <Frac top="5" bot="7" />, id:'w1'}, {el: <Frac top="6" bot="12" />, id:'w2'}, {el: <Frac top="8" bot="9" />, id:'w3'}]);
                return { category: 'Bruchrechnen', question: <span className="flex items-center gap-1">Multipliziere und kÃ¼rze: <Frac top={a} bot={b} /> Â· <Frac top={c} bot={d} /></span>, options: options.map(o => o.el), correctAnswer: options.findIndex(o => o.id === 'c'), explanation: <span className="flex items-center gap-1">ZÃ¤hler mal ZÃ¤hler, Nenner mal Nenner: <Frac top={a*c} bot={b*d} />. GekÃ¼rzt mit 6 ergibt das <Frac top="1" bot="2" />.</span> };
            }
        };

        const genGeo = (diff) => {
            if (diff === 'leicht') {
                const k = [2, 3, 4][Math.floor(Math.random()*3)]; const k2 = k*k;
                const options = shuffleArray([`Faktor ${k2}`, `Faktor ${k*2}`, `Faktor ${k}`, `Faktor ${k*k*k}`]);
                return { category: 'Geometrie (FlÃ¤che)', question: `Die SeitenlÃ¤nge eines Quadrats wird mit k = ${k} vergrÃ¶ÃŸert. Mit welchem Faktor wÃ¤chst der FlÃ¤cheninhalt?`, options, correctAnswer: options.indexOf(`Faktor ${k2}`), explanation: `Bei FlÃ¤chen Ã¤ndert sich der Inhalt quadratisch (kÂ²). Also rechnen wir: ${k}Â² = ${k2}.` };
            } else if (diff === 'mittel') {
                const k = [2, 3, 4, 5, 10][Math.floor(Math.random()*5)]; const k3 = k*k*k;
                const options = shuffleArray([`Faktor ${k3}`, `Faktor ${k*2}`, `Faktor ${k*k}`, `Faktor ${k}`]);
                return { category: 'Geometrie (Volumen)', question: `Der Radius einer Kugel wird mit dem Faktor k = ${k} vergrÃ¶ÃŸert. Mit welchem Faktor wÃ¤chst das Volumen?`, options, correctAnswer: options.indexOf(`Faktor ${k3}`), explanation: `Im Dreidimensionalen Ã¤ndert sich das Volumen mit dem Faktor kÂ³. Hier ist k = ${k}. Also rechnen wir: ${k}Â³ = ${k} Â· ${k} Â· ${k} = ${k3}.` };
            } else {
                const k = [2, 3, 4, 5][Math.floor(Math.random()*4)]; const k3 = k*k*k;
                const options = shuffleArray([`k = ${k}`, `k = ${k3}`, `k = ${k*k}`, `k = ${Math.floor(k3/3)}`]);
                return { category: 'Geometrie (Streckung)', question: `Das Volumen eines WÃ¼rfels hat sich um den Faktor ${k3} vergrÃ¶ÃŸert. Welcher Streckungsfaktor k wurde fÃ¼r die KantenlÃ¤nge verwendet?`, options, correctAnswer: options.indexOf(`k = ${k}`), explanation: `Das Volumen wÃ¤chst mit kÂ³. Wir suchen also die Zahl, die dreimal mit sich selbst multipliziert ${k3} ergibt (die 3. Wurzel). Das ist ${k}.` };
            }
        };

        const genProb = (diff) => {
            if (diff === 'leicht') {
                const tot = 10; const red = Math.floor(Math.random()*5)+2;
                const options = shuffleArray([{el: <Frac top={red} bot={tot}/>, id: 'c'}, {el: <Frac top={red-1} bot={tot}/>, id: 'w1'}, {el: <Frac top={tot} bot={red}/>, id: 'w2'}, {el: <Frac top={red+1} bot={tot}/>, id: 'w3'}]);
                return { category: 'Wahrscheinlichkeit', question: `In einer Urne liegen ${tot} Kugeln, davon sind ${red} rot. Wie groÃŸ ist die Wahrscheinlichkeit, eine rote zu ziehen?`, options: options.map(o=>o.el), correctAnswer: options.findIndex(o=>o.id==='c'), explanation: <span className="flex items-center gap-1">Die Formel lautet: (GÃ¼nstige Ergebnisse) / (Alle Ergebnisse) = <Frac top={red} bot={tot}/>.</span> };
            } else if (diff === 'mittel') {
                const total = [20, 50, 100][Math.floor(Math.random() * 3)];
                const fracs = [{ t: 1, b: 4, v: 0.25 }, { t: 1, b: 5, v: 0.2 }, { t: 1, b: 10, v: 0.1 }]; 
                const f = fracs[Math.floor(Math.random() * 3)];
                const black = total * f.v;
                if (!Number.isInteger(black)) return genProb(diff); // Schutz vor halben Kugeln
                const optionsArray = [black, black + 2, Math.abs(black - 2)||1, black * 2].map(n => `${n} Kugeln`);
                const options = shuffleArray(optionsArray);
                return { category: 'Wahrscheinlichkeit', question: <span className="flex flex-wrap items-center gap-1">In einer Urne sind {total} Kugeln. Die Wahrscheinlichkeit fÃ¼r "Schwarz" betrÃ¤gt <Frac top={f.t} bot={f.b} />. Wie viele schwarze Kugeln gibt es?</span>, options, correctAnswer: options.indexOf(`${black} Kugeln`), explanation: <span className="flex flex-wrap items-center gap-1">Ein Anteil von <Frac top={f.t} bot={f.b} /> von {total} Kugeln entspricht genau {total} / {f.b} = {black} Kugeln.</span> };
            } else {
                const red = 3; const blue = 2; const tot = red+blue; // 5
                const options = shuffleArray([{el: <Frac top="3" bot="10"/>, id: 'c'}, {el: <Frac top="9" bot="25"/>, id: 'w1'}, {el: <Frac top="6" bot="25"/>, id: 'w2'}, {el: <Frac top="2" bot="5"/>, id: 'w3'}]);
                return { category: 'Wahrscheinlichkeit', question: `In einer Urne sind ${red} rote und ${blue} blaue Kugeln. Du ziehst 2 Kugeln OHNE ZurÃ¼cklegen. Wahrscheinlichkeit fÃ¼r "rot und dann nochmal rot"?`, options: options.map(o=>o.el), correctAnswer: options.findIndex(o=>o.id==='c'), explanation: <span className="flex items-center flex-wrap gap-1">Erster Zug: <Frac top="3" bot="5"/>. Beim zweiten Zug ist eine rote weniger da: <Frac top="2" bot="4"/>. Multipliziert: <Frac top="3" bot="5"/> Â· <Frac top="2" bot="4"/> = <Frac top="6" bot="20"/>, gekÃ¼rzt <Frac top="3" bot="10"/>.</span> };
            }
        };

        const genQuad = (diff) => {
            if (diff === 'leicht') {
                const c = Math.floor(Math.random()*9)-4; const correct = `S(0 | ${c})`;
                const options = shuffleArray([correct, `S(${c} | 0)`, `S(0 | ${-c})`, `S(${-c} | 0)`]);
                return { category: 'Quadratische Funktionen', question: <span className="flex items-center gap-1">Lies den Scheitelpunkt der Parabel ab: y = x<sup>2</sup> {c >= 0 ? '+ ' + c : '- ' + Math.abs(c)}</span>, options, correctAnswer: options.indexOf(correct), explanation: `Die Parabel ist nur auf der y-Achse verschoben, nicht auf der x-Achse. Daher liegt der Scheitelpunkt bei x=0 und y=${c}.` };
            } else if (diff === 'mittel') {
                const d = Math.floor(Math.random()*5)+1; const signD = Math.random()>0.5 ? 1 : -1;
                const e = Math.floor(Math.random()*5)+1; const signE = Math.random()>0.5 ? 1 : -1;
                const correct = `S(${signD * d} | ${signE * e})`;
                const options = shuffleArray([correct, `S(${-signD * d} | ${signE * e})`, `S(${signD * d} | ${-signE * e})`, `S(${-signD * d} | ${-signE * e})`]);
                return { category: 'Quadratische Funktionen', question: <span className="flex items-center gap-1">Lies den Scheitelpunkt ab: y = (x {signD < 0 ? '+ ' + d : '- ' + d})<sup>2</sup> {signE > 0 ? '+ ' + e : '- ' + e}</span>, options, correctAnswer: options.indexOf(correct), explanation: `Aus der Scheitelpunktform y = (x - d)Â² + e liest man den Scheitel S(d | e) ab. Achte auf das umgedrehte Vorzeichen in der Klammer!` };
            } else {
                const xs = Math.floor(Math.random() * 4) + 1; const ys = Math.floor(Math.random() * 4) + 1;
                const p = -2 * xs; const q = xs*xs + ys;
                const correct = `S(${xs} | ${ys})`;
                const options = shuffleArray([correct, `S(${-xs} | ${ys})`, `S(${xs} | ${-ys})`, `S(${-xs} | ${-ys})`]);
                return { category: 'Quadratische Funktionen', question: <span className="flex items-center gap-1">Wo liegt der Scheitelpunkt von y = x<sup>2</sup> {p >= 0 ? '+ ' + p : '- ' + Math.abs(p)}x {q >= 0 ? '+ ' + q : '- ' + Math.abs(q)} ?</span>, options, correctAnswer: options.indexOf(correct), explanation: `Nutze die Formel fÃ¼r die x-Koordinate: xs = -p / 2 = ${-p} / 2 = ${xs}. Setzt man ${xs} in die Gleichung ein, erhÃ¤lt man ys = ${ys}. Also ${correct}.` };
            }
        };

        const genPotenz = (diff) => {
            if (diff === 'leicht') {
                const a = Math.floor(Math.random()*5)+2; const b = Math.floor(Math.random()*4)+2;
                const options = shuffleArray([{ el: <span className="flex items-center">x<sup>{a+b}</sup></span>, id: 'c' }, { el: <span className="flex items-center">x<sup>{a*b}</sup></span>, id: 'w1' }, { el: <span className="flex items-center">x<sup>{Math.abs(a-b)||1}</sup></span>, id: 'w2' }, { el: <span className="flex items-center">2x<sup>{a+b}</sup></span>, id: 'w3' }]);
                return { category: 'Potenzgesetze', question: <span className="flex items-center gap-1">Fasse zusammen: x<sup>{a}</sup> Â· x<sup>{b}</sup></span>, options: options.map(o=>o.el), correctAnswer: options.findIndex(o=>o.id==='c'), explanation: <span className="flex items-center gap-1">Bei Multiplikation mit gleicher Basis werden die Exponenten addiert: {a} + {b} = {a+b}. Also x<sup>{a+b}</sup>.</span> };
            } else if (diff === 'mittel') {
                const a = Math.floor(Math.random()*3)+2; const b = Math.floor(Math.random()*3)+2;
                const options = shuffleArray([{ el: <span className="flex items-center">x<sup>{a*b}</sup></span>, id: 'c' }, { el: <span className="flex items-center">x<sup>{a+b}</sup></span>, id: 'w1' }, { el: <span className="flex items-center">x<sup>{Math.pow(a,b)}</sup></span>, id: 'w2' }, { el: <span className="flex items-center">2x<sup>{a*b}</sup></span>, id: 'w3' }]);
                return { category: 'Potenzgesetze', question: <span className="flex items-center gap-1">Fasse zusammen: (x<sup>{a}</sup>)<sup>{b}</sup></span>, options: options.map(o=>o.el), correctAnswer: options.findIndex(o=>o.id==='c'), explanation: <span className="flex items-center gap-1">Wird eine Potenz potenziert, werden die Exponenten multipliziert: {a} Â· {b} = {a*b}. Also x<sup>{a*b}</sup>.</span> };
            } else {
                const base = [2, 3][Math.floor(Math.random()*2)]; const e = -Math.floor(Math.random()*2)-2; 
                const ans = Math.pow(base, Math.abs(e));
                const options = shuffleArray([{el: <Frac top="1" bot={ans}/>, id:'c'}, {el: `-${ans}`, id:'w1'}, {el: <Frac top="-1" bot={ans}/>, id:'w2'}, {el: String(ans), id:'w3'}]);
                return { category: 'Potenzgesetze', question: <span className="flex items-center gap-1">Berechne im Kopf: {base}<sup>{e}</sup></span>, options: options.map(o=>o.el), correctAnswer: options.findIndex(o=>o.id==='c'), explanation: <span className="flex items-center gap-1">Ein negativer Exponent bedeutet den Kehrbruch. {base}<sup>{e}</sup> ist also 1 / {base}<sup>{Math.abs(e)}</sup>. Das ergibt <Frac top="1" bot={ans}/>.</span> };
            }
        };

        const genDef = (diff) => {
            if (diff === 'leicht') {
                const a = Math.floor(Math.random() * 9) - 4; if(a===0) return genDef('leicht');
                const sign = a > 0 ? `+ ${a}` : `- ${Math.abs(a)}`; const val = -a;
                const correctD = `D = â„ \\ {${val}}`;
                const opts = shuffleArray([correctD, `D = â„ \\ {${-val}}`, `D = â„ \\ {0}`, `D = â„`]);
                return { category: 'Definitionsmenge', question: <span className="flex items-center gap-1">Welche Definitionsmenge hat der Term: <Frac top="1" bot={`x ${sign}`}/> ?</span>, options: opts, correctAnswer: opts.indexOf(correctD), explanation: `Der Nenner darf nicht 0 werden. Die Gleichung x ${sign} = 0 liefert x = ${val}. Dieser Wert muss ausgeschlossen werden.` };
            } else if (diff === 'mittel') {
                const a = Math.floor(Math.random()*4)+1; const b = Math.floor(Math.random()*4)+1 + a; 
                const correctD = `D = â„ \\ {${a}; ${b}}`;
                const opts = shuffleArray([correctD, `D = â„ \\ {${-a}; ${-b}}`, `D = â„ \\ {${a}}`, `D = â„ \\ {0; ${a}}`]);
                return { category: 'Definitionsmenge', question: <span className="flex items-center gap-1">Finde D fÃ¼r: <Frac top="5" bot={`(x - ${a})(x - ${b})`}/></span>, options: opts, correctAnswer: opts.indexOf(correctD), explanation: `Ein Produkt ist 0, wenn einer der Faktoren 0 ist. Das passiert hier bei x = ${a} und x = ${b}. Beide mÃ¼ssen aus â„ ausgeschlossen werden.` };
            } else {
                const a = Math.floor(Math.random()*4)+2; const a2 = a*a;
                const correctD = `D = â„ \\ {${-a}; ${a}}`;
                const opts = shuffleArray([correctD, `D = â„ \\ {${a2}}`, `D = â„ \\ {${a}}`, `D = â„ \\ {0; ${a}}`]);
                return { category: 'Definitionsmenge', question: <span className="flex items-center gap-1">Bestimme D: <Frac top="2" bot={`xÂ² - ${a2}`}/></span>, options: opts, correctAnswer: opts.indexOf(correctD), explanation: `Der Nenner xÂ² - ${a2} wird 0, wenn xÂ² = ${a2} ist. Dies gilt fÃ¼r x = ${a} UND x = ${-a}. Beide Werte mÃ¼ssen ausgeschlossen werden.` };
            }
        };

        const generators = [
            { id: 'prozent', fn: genProzent }, { id: 'linear', fn: genLinear }, { id: 'bruch', fn: genBruch }, { id: 'geo', fn: genGeo },
            { id: 'prob', fn: genProb }, { id: 'quad', fn: genQuad }, { id: 'potenz', fn: genPotenz }, { id: 'def', fn: genDef }
        ];

        const generateKopfrechenQuestion = (diff, lastCatId) => {
            const available = generators.filter(g => g.id !== lastCatId);
            const selected = available[Math.floor(Math.random() * available.length)];
            return { ...selected.fn(diff), categoryId: selected.id };
        };

        const KopfrechenTrainer = () => {
            const [difficulty, setDifficulty] = useState('mittel');
            const [currentQuestion, setCurrentQuestion] = useState(() => generateKopfrechenQuestion('mittel', null));
            const [selectedOption, setSelectedOption] = useState(null);
            const [isAnswerChecked, setIsAnswerChecked] = useState(false);
            const [tipRevealed, setTipRevealed] = useState(false);
            
            const [streak, setStreak] = useState(() => getStorage('smarth_streak_kopf', 0));
            const [showAnim, setShowAnim] = useState(false);

            useEffect(() => { setStorage('smarth_streak_kopf', streak); }, [streak]);

            const handleDifficultyChange = (newDiff) => {
                setDifficulty(newDiff);
                setCurrentQuestion(generateKopfrechenQuestion(newDiff, currentQuestion?.categoryId));
                setSelectedOption(null);
                setIsAnswerChecked(false);
                setTipRevealed(false);
            };

            const handleOptionSelect = (index) => {
                if (!isAnswerChecked) setSelectedOption(index);
            };

            const handleCheckAnswer = () => {
                if (selectedOption === null) return;
                setIsAnswerChecked(true);
                const isCorrect = selectedOption === currentQuestion.correctAnswer;
                
                if (isCorrect && !tipRevealed) {
                    const newStreak = streak + 1;
                    setStreak(newStreak);
                    if (newStreak > 0 && newStreak % 6 === 0) triggerCelebration(setShowAnim);
                } else {
                    setStreak(0);
                }
            };

            const loadNextQuestion = () => {
                setCurrentQuestion(generateKopfrechenQuestion(difficulty, currentQuestion.categoryId));
                setSelectedOption(null);
                setIsAnswerChecked(false);
                setTipRevealed(false);
            };

            const handleSkip = () => {
                setStreak(0); // Ãœberspringen bricht den Streak
                loadNextQuestion();
            };

            const handleShowTip = () => {
                setTipRevealed(true);
                setStreak(0); // Tipp ansehen bricht den Streak
            };

            const getOptionStyles = (index) => {
                if (!isAnswerChecked) {
                    return selectedOption === index ? 'border-sky-500 bg-sky-50 ring-2 ring-sky-200' : 'border-slate-200 hover:border-sky-300 hover:bg-slate-50';
                }
                if (index === currentQuestion.correctAnswer) return 'border-green-500 bg-green-50 text-green-800 ring-2 ring-green-200';
                if (index === selectedOption && index !== currentQuestion.correctAnswer) return 'border-red-500 bg-red-50 text-red-800 ring-2 ring-red-200';
                return 'border-slate-200 opacity-50';
            };

            return (
                <div className="page-transition max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    {showAnim && <CelebrationOverlay />}
                    
                    <header className="bg-sky-500 text-sky-950 shadow-md p-6 rounded-xl mb-6">
                        <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div className="flex items-center space-x-3 text-white">
                                <CalculatorOff className="w-8 h-8" />
                                <div>
                                    <h1 className="text-2xl font-bold tracking-tight flex items-center">Kopfrechnen <span className="hidden sm:inline text-sky-200 text-lg font-normal border-l-2 border-sky-400 pl-2 ml-2">MSA Training</span></h1>
                                </div>
                            </div>
                            <div className="bg-sky-600 px-4 py-1.5 rounded-full text-sm font-bold shadow-sm flex items-center text-white">
                                <Target className="w-4 h-4 mr-2 text-sky-200" /> Streak: {streak}
                            </div>
                        </div>
                    </header>

                    {/* Difficulty Selector */}
                    <div className="flex flex-col sm:flex-row items-center justify-center gap-3 mb-6 bg-white p-3 rounded-xl shadow-sm border border-slate-200">
                        <span className="font-bold text-slate-700">Neue Aufgabe generieren:</span>
                        <div className="flex gap-2">
                            {['leicht', 'mittel', 'schwer'].map(d => (
                                <button key={d} onClick={() => handleDifficultyChange(d)} className={`px-4 py-2 font-bold rounded-lg shadow-sm transition-colors ${difficulty === d ? 'bg-sky-500 text-white' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'}`}>
                                    {d.charAt(0).toUpperCase() + d.slice(1)}
                                </button>
                            ))}
                        </div>
                    </div>

                    <main className="space-y-6 relative">
                        <div className="bg-white rounded-3xl shadow-md overflow-hidden border border-slate-200">
                            {/* Card Header */}
                            <div className="bg-sky-50 px-6 py-4 border-b border-sky-200 flex justify-between items-center relative overflow-hidden">
                                <div className="relative z-10 flex items-center text-sky-900 font-bold text-lg"><BookOpen className="w-5 h-5 mr-2 text-sky-600" /> {currentQuestion.category}</div>
                                <div className="absolute -right-4 -top-4 opacity-10"><CalculatorOff className="w-24 h-24" /></div>
                            </div>

                            {/* Quiz Area */}
                            <div className="p-6 md:p-8">
                                <div className="mb-8 min-h-[60px] flex items-center">
                                    <h2 className="text-xl md:text-2xl font-semibold text-slate-800 leading-snug">{currentQuestion.question}</h2>
                                </div>

                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-8">
                                    {currentQuestion.options.map((option, index) => (
                                        <button key={index} onClick={() => handleOptionSelect(index)} disabled={isAnswerChecked} className={`text-left p-4 rounded-xl border-2 transition-all duration-200 flex items-center justify-between ${getOptionStyles(index)}`}>
                                            <span className="font-medium text-[16px] flex flex-wrap items-center gap-1">{option}</span>
                                            {isAnswerChecked && index === currentQuestion.correctAnswer && <CheckCircle className="w-6 h-6 text-green-500 flex-shrink-0 ml-3" />}
                                            {isAnswerChecked && index === selectedOption && index !== currentQuestion.correctAnswer && <XCircle className="w-6 h-6 text-red-500 flex-shrink-0 ml-3" />}
                                        </button>
                                    ))}
                                </div>

                                {!isAnswerChecked && (
                                    <div className="mb-6">
                                        {!tipRevealed ? (
                                            <button onClick={handleShowTip} className="text-sky-600 bg-sky-50 hover:bg-sky-100 px-4 py-2 rounded-lg font-medium flex items-center transition-colors border border-sky-200">
                                                <HelpCircle className="w-5 h-5 mr-2" /> LÃ¶sungsweg anzeigen (Tipp)
                                            </button>
                                        ) : (
                                            <div className="bg-sky-50 border-l-4 border-sky-500 p-4 rounded shadow-sm text-sky-900 text-sm animate-fade-in flex">
                                                <HelpCircle className="w-6 h-6 mr-3 shrink-0 text-sky-600" />
                                                <div><strong className="block mb-1 text-sky-800">Tipp / LÃ¶sungsweg:</strong> <span className="flex flex-wrap items-center gap-1">{currentQuestion.explanation}</span></div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {isAnswerChecked && (
                                    <div className="mb-8 p-5 bg-sky-50 border border-sky-100 rounded-xl animate-fade-in flex flex-col sm:flex-row gap-4">
                                        <div className="shrink-0 pt-1"><HelpCircle className="w-6 h-6 text-sky-600" /></div>
                                        <div>
                                            <h3 className="text-sm font-bold text-sky-800 uppercase tracking-wider mb-1">ErklÃ¤rung</h3>
                                            <p className="text-sky-900 leading-relaxed font-medium flex flex-wrap items-center gap-1">{currentQuestion.explanation}</p>
                                        </div>
                                    </div>
                                )}

                                <div className="flex justify-between items-center border-t border-slate-100 pt-6 mt-4">
                                    {!isAnswerChecked ? (
                                        <>
                                            <button onClick={handleSkip} className="flex items-center gap-2 py-3 px-5 rounded-xl font-medium text-slate-500 hover:text-slate-800 hover:bg-slate-100 transition-all">
                                                <FastForward className="w-5 h-5" /> <span className="hidden sm:inline">Ãœberspringen</span>
                                            </button>
                                            <button onClick={handleCheckAnswer} disabled={selectedOption === null} className={`py-3 px-8 rounded-xl font-semibold transition-all flex items-center ${selectedOption !== null ? 'bg-sky-500 hover:bg-sky-600 text-white shadow-md transform hover:-translate-y-0.5' : 'bg-slate-100 text-slate-400 cursor-not-allowed'}`}>
                                                Antwort prÃ¼fen <ArrowRight className="w-5 h-5 ml-2" />
                                            </button>
                                        </>
                                    ) : (
                                        <button onClick={loadNextQuestion} className="w-full flex justify-center items-center gap-2 py-4 px-8 rounded-xl font-bold bg-slate-800 hover:bg-slate-900 text-white transition-all shadow-md transform hover:-translate-y-0.5 text-lg animate-fade-in">
                                            NÃ¤chste Aufgabe <ChevronRight className="w-6 h-6" />
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        // ==========================================
        // 6. SEITEN (Home, Impressum, etc.)
        // ==========================================

        const HomePage = ({ navigateTo }) => (
            <div className="page-transition">
                <section className="bg-gradient-to-b from-indigo-50 to-slate-50 py-16 sm:py-24 border-b border-slate-200">
                    <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row items-center gap-8 md:gap-12">
                        <div className="shrink-0 relative flex justify-center">
                            <div className="absolute inset-0 bg-indigo-200 blur-2xl opacity-30 scale-125 rounded-full"></div>
                            <img src="Logo-sMArTH.png" alt="sMArTHEMATIK Logo" className="relative w-64 md:w-80 h-auto object-contain drop-shadow-sm" />
                        </div>
                        <div className="text-center md:text-left space-y-4">
                            <div className="inline-block px-3 py-1 bg-indigo-100 text-indigo-700 text-sm font-semibold rounded-full mb-2">sMArTHEMATIK Ãœbungen</div>
                            <h2 className="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900">
                                Herzlich willkommen auf dieser Ãœbungsseite fÃ¼r die 10. Klasse Mittelschule in Bayern!
                            </h2>
                            <p className="text-lg text-slate-600 max-w-2xl leading-relaxed">Hier stehen dir verschiedene interaktive Mathetrainer und digitale Lerntools zum Ãœben zur VerfÃ¼gung.</p>
                        </div>
                    </div>
                </section>

                <section className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
                    <div className="text-center mb-12"><h3 className="text-2xl font-bold text-slate-800">VerfÃ¼gbare Mathetrainer</h3></div>
                    <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div className="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm hover:shadow-xl transition-all hover:-translate-y-1 flex flex-col items-center text-center group cursor-pointer" onClick={() => navigateTo('wachstum')}>
                            <div className="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"><TrendingUp className="w-8 h-8" /></div>
                            <h4 className="text-xl font-bold text-slate-800 mb-3">Wachstum & Zerfall</h4>
                            <p className="text-slate-600 mb-8 flex-grow text-sm">Zinseszins, BevÃ¶lkerung und Wertverlust (q {'>'} 0) berechnen.</p>
                            <button className="w-full inline-flex items-center justify-center px-4 py-2 border border-emerald-200 font-medium rounded-lg text-emerald-700 bg-emerald-50 group-hover:bg-emerald-600 group-hover:text-white shadow-sm transition-all">Zum Trainer</button>
                        </div>
                        <div className="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm hover:shadow-xl transition-all hover:-translate-y-1 flex flex-col items-center text-center group cursor-pointer" onClick={() => navigateTo('zerfall')}>
                            <div className="w-16 h-16 bg-rose-100 text-rose-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"><TrendingDown className="w-8 h-8" /></div>
                            <h4 className="text-xl font-bold text-slate-800 mb-3">Halbwertszeit</h4>
                            <p className="text-slate-600 mb-8 flex-grow text-sm">RadioaktivitÃ¤t und Medikamente abbauen (q = 0,5).</p>
                            <button className="w-full inline-flex items-center justify-center px-4 py-2 border border-rose-200 font-medium rounded-lg text-rose-700 bg-rose-50 group-hover:bg-rose-600 group-hover:text-white shadow-sm transition-all">Zum Trainer</button>
                        </div>
                        <div className="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm hover:shadow-xl transition-all hover:-translate-y-1 flex flex-col items-center text-center group cursor-pointer" onClick={() => navigateTo('gleichungen')}>
                            <div className="w-16 h-16 bg-amber-100 text-amber-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"><FractionIcon className="w-8 h-8" /></div>
                            <h4 className="text-xl font-bold text-slate-800 mb-3">Bruchgleichungen</h4>
                            <p className="text-slate-600 mb-8 flex-grow text-sm">Training zur LÃ¶sung komplexer Bruchgleichungen mit pq-Formel.</p>
                            <button className="w-full inline-flex items-center justify-center px-4 py-2 border border-amber-200 font-medium rounded-lg text-amber-700 bg-amber-50 group-hover:bg-amber-600 group-hover:text-white shadow-sm transition-all">Zum Trainer</button>
                        </div>
                        <div className="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm hover:shadow-xl transition-all hover:-translate-y-1 flex flex-col items-center text-center group cursor-pointer" onClick={() => navigateTo('kopfrechnen')}>
                            <div className="w-16 h-16 bg-sky-100 text-sky-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform"><CalculatorOff className="w-8 h-8" /></div>
                            <h4 className="text-xl font-bold text-slate-800 mb-3">Kopfrechnen</h4>
                            <p className="text-slate-600 mb-8 flex-grow text-sm">Schnelles Denken: Verschiedene Aufgabentypen fÃ¼r den MSA im Kopf lÃ¶sen.</p>
                            <button className="w-full inline-flex items-center justify-center px-4 py-2 border border-sky-200 font-medium rounded-lg text-sky-700 bg-sky-50 group-hover:bg-sky-500 group-hover:text-white shadow-sm transition-all">Zum Trainer</button>
                        </div>
                    </div>
                </section>
            </div>
        );

        const ImpressumPage = ({ navigateTo }) => (
            <div className="page-transition max-w-3xl mx-auto px-4 sm:px-6 py-16 text-slate-800">
                <div className="flex items-center gap-3 mb-8"><FileText className="w-8 h-8 text-indigo-600"/><h1 className="text-3xl font-bold">Impressum</h1></div>
                <div className="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm space-y-6">
                    <div><h2 className="text-xl font-bold mb-2">Angaben gemÃ¤ÃŸ Â§ 5 TMG</h2><p>Martin Geiger<br />Beratung digitale Bildung<br />Eduard-Ziegler-Str. 3<br />85221 Dachau</p></div>
                    <div><h2 className="text-xl font-bold mb-2">Kontakt</h2><p>Telefon: 08131/741799<br />E-Mail: martin.geiger@ms-dachau-sued.de</p></div>
                    <div><h2 className="text-xl font-bold mb-2">Redaktionell verantwortlich</h2><p>Martin Geiger<br />Eduard-Ziegler-Str. 3<br />85221 Dachau</p></div>
                </div>
                <div className="mt-12 flex justify-center"><button onClick={() => navigateTo('home')} className="inline-flex items-center gap-2 px-6 py-3 bg-white hover:bg-slate-50 border border-slate-200 text-slate-700 font-medium rounded-xl transition-all shadow-sm hover:shadow-md hover:-translate-y-0.5"><HomeIcon className="w-5 h-5 text-indigo-500" /> ZurÃ¼ck zur Startseite</button></div>
            </div>
        );

        const DatenschutzPage = ({ navigateTo }) => (
            <div className="page-transition max-w-3xl mx-auto px-4 sm:px-6 py-16 text-slate-800">
                <div className="flex items-center gap-3 mb-8"><Shield className="w-8 h-8 text-indigo-600"/><h1 className="text-3xl font-bold">DatenschutzerklÃ¤rung</h1></div>
                <div className="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm space-y-6">
                    <h2 className="text-xl font-bold">1. Datenschutz auf einen Blick</h2>
                    <h3 className="font-bold">Allgemeine Hinweise</h3>
                    <p>Die folgenden Hinweise geben einen einfachen Ãœberblick darÃ¼ber, was mit Ihren personenbezogenen Daten passiert, wenn Sie diese Website besuchen.</p>
                    <h2 className="text-xl font-bold mt-8">2. Hosting</h2>
                    <p>Diese Website wird bei dem externen Dienstleister GitHub Inc. gehostet.</p>
                    <h2 className="text-xl font-bold mt-8">3. Lokale Speicherung (Local Storage)</h2>
                    <p>Die Mathetrainer auf dieser Webseite nutzen Ihren Browser, um Ihren aktuellen Lernfortschritt (Streak-Zahl) temporÃ¤r im "Local Storage" zu speichern. Dies dient ausschlieÃŸlich Ihrer eigenen Motivation Ã¼ber mehrere Tage hinweg. Es werden dabei keine persÃ¶nlichen Daten erfasst und die Daten verlassen Ihren Browser zu keinem Zeitpunkt.</p>
                    <h2 className="text-xl font-bold mt-8">4. Anonymer BesucherzÃ¤hler</h2>
                    <p>Ganz unten auf der Webseite befindet sich ein kleiner, rein visueller Seitenaufruf-ZÃ¤hler des Open-Source Dienstes "hits.sh". Dieser zÃ¤hlt Aufrufe streng anonym und verzichtet komplett auf das Setzen von Cookies oder das Tracking von IP-Adressen.</p>
                </div>
                <div className="mt-12 flex justify-center"><button onClick={() => navigateTo('home')} className="inline-flex items-center gap-2 px-6 py-3 bg-white hover:bg-slate-50 border border-slate-200 text-slate-700 font-medium rounded-xl transition-all shadow-sm hover:shadow-md hover:-translate-y-0.5"><HomeIcon className="w-5 h-5 text-indigo-500" /> ZurÃ¼ck zur Startseite</button></div>
            </div>
        );

        // ==========================================
        // 7. HAUPT-APP ROUTER
        // ==========================================
        const App = () => {
            const [currentPage, setCurrentPage] = useState('home');
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

            useEffect(() => { window.scrollTo(0, 0); setMobileMenuOpen(false); }, [currentPage]);

            const NavButton = ({ id, label, icon: Icon }) => {
                const isActive = currentPage === id;
                return <button onClick={() => setCurrentPage(id)} className={`flex items-center gap-2 px-3 py-2 rounded-lg font-medium transition-colors ${isActive ? 'text-indigo-600 bg-indigo-50' : 'text-slate-600 hover:text-indigo-600 hover:bg-slate-50'}`}>{Icon && <Icon className="w-4 h-4" />}<span className="whitespace-nowrap">{label}</span></button>;
            };

            return (
                <div className="flex flex-col min-h-screen">
                    <header className="bg-white shadow-sm sticky top-0 z-50 border-b border-slate-200">
                        <div className="max-w-[1200px] mx-auto px-2 sm:px-6 lg:px-8 h-16 flex items-center justify-between gap-1 sm:gap-4">
                            
                            {/* Links: Hauptlogo */}
                            <button onClick={() => setCurrentPage('home')} className="flex items-center hover:opacity-80 transition-opacity shrink-0">
                                <img src="Logo-sMArTH.png" alt="sMArTHEMATIK Logo" className="h-5 sm:h-8 md:h-10 w-auto object-contain" />
                            </button>
                            
                            {/* Mitte: MS-SÃ¼d Logo klickbar */}
                            <a href="https://ms-dachau-sued.de/" target="_blank" rel="noopener noreferrer" className="flex-grow flex justify-center items-center px-1 sm:px-2 hover:opacity-80 transition-opacity min-w-0">
                                <img src="LogoMSsued2.jpg" alt="Mittelschule Dachau-SÃ¼d Logo" className="h-4 sm:h-8 md:h-10 w-auto object-contain shadow-sm rounded-sm" />
                            </a>

                            {/* Rechts: Navigation & BdB Logo */}
                            <div className="flex items-center gap-1 sm:gap-3 shrink-0">
                                <nav className="hidden lg:flex items-center gap-1 mr-2">
                                    <NavButton id="home" label="Startseite" icon={HomeIcon} />
                                    <NavButton id="wachstum" label="Wachstum" icon={TrendingUp} />
                                    <NavButton id="zerfall" label="Halbwertszeit" icon={TrendingDown} />
                                    <NavButton id="gleichungen" label="Bruchgleichungen" icon={FractionIcon} />
                                    <NavButton id="kopfrechnen" label="Kopfrechnen" icon={CalculatorOff} />
                                </nav>
                                <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="lg:hidden p-1 sm:p-2 text-slate-600 hover:bg-slate-50 rounded-lg">
                                    {mobileMenuOpen ? <XCircle className="w-6 h-6" /> : <MenuIcon className="w-6 h-6" />}
                                </button>
                                <img src="cropped-BdB_Logo-1.png" alt="Beratung digitale Bildung Logo" className="h-6 sm:h-10 md:h-12 w-auto object-contain" />
                            </div>
                        </div>

                        {mobileMenuOpen && (
                            <div className="lg:hidden bg-white border-t border-slate-100 p-4 flex flex-col gap-2 shadow-lg absolute w-full z-50">
                                <NavButton id="home" label="Startseite" icon={HomeIcon} />
                                <NavButton id="wachstum" label="Wachstum & Zerfall" icon={TrendingUp} />
                                <NavButton id="zerfall" label="Halbwertszeit" icon={TrendingDown} />
                                <NavButton id="gleichungen" label="Bruchgleichungen" icon={FractionIcon} />
                                <NavButton id="kopfrechnen" label="Kopfrechnen" icon={CalculatorOff} />
                            </div>
                        )}
                    </header>

                    <main className="flex-grow">
                        {currentPage === 'home' && <HomePage navigateTo={setCurrentPage} />}
                        {currentPage === 'wachstum' && <WachstumsTrainer />}
                        {currentPage === 'zerfall' && <ZerfallsTrainer />}
                        {currentPage === 'gleichungen' && <BruchgleichungsTrainer />}
                        {currentPage === 'kopfrechnen' && <KopfrechenTrainer />}
                        {currentPage === 'impressum' && <ImpressumPage navigateTo={setCurrentPage} />}
                        {currentPage === 'datenschutz' && <DatenschutzPage navigateTo={setCurrentPage} />}
                    </main>

                    <footer className="bg-slate-900 text-slate-400 py-10 mt-auto border-t-4 border-indigo-600">
                        <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col items-center text-center space-y-6">
                            <div>
                                <h4 className="text-white text-lg font-bold uppercase tracking-wider mb-4">Kontakt & Infos</h4>
                                <a href="mailto:martin.geiger@ms-dachau-sued.de" className="inline-block px-6 py-2 bg-slate-800 text-slate-200 font-semibold rounded-lg hover:bg-indigo-600 hover:text-white transition-colors shadow-sm text-sm">E-Mail senden</a>
                                <p className="text-xs text-slate-500 mt-6 max-w-2xl mx-auto">
                                    Hinweis: FÃ¼r die Richtigkeit der generierten Aufgaben und Berechnungen kann keine Garantie Ã¼bernommen werden.
                                    <br/><br/>
                                    Quelle der PrÃ¼fungsaufgaben im Bereich Bruchgleichungen: <a href="https://www.bycs.de/pruefungsarchiv" target="_blank" rel="noopener noreferrer" className="underline hover:text-slate-300 transition-colors">PrÃ¼fungsarchiv des Bayerischen Staatsministeriums fÃ¼r Unterricht und Kultus (bycs.de)</a>.
                                </p>
                            </div>
                            
                            <div className="w-full border-t border-slate-800 pt-6 mt-2 flex flex-col justify-between items-center text-sm gap-4">
                                <div className="flex flex-col md:flex-row items-center w-full justify-between gap-4">
                                    <div>&copy; 2026 - <strong className="text-white">Martin Geiger</strong></div>
                                    <div className="flex items-center gap-4">
                                        <button onClick={() => setCurrentPage('impressum')} className="hover:text-white transition-colors">Impressum</button>
                                        <span className="text-slate-700">|</span>
                                        <button onClick={() => setCurrentPage('datenschutz')} className="hover:text-white transition-colors">Datenschutz</button>
                                    </div>
                                </div>
                                
                                {/* Anonymer Hit-Counter (Cookie-frei) */}
                                <div className="mt-4 flex items-center gap-2 opacity-50 hover:opacity-100 transition-opacity grayscale hover:grayscale-0">
                                    <img src="https://hits.sh/ms-dachau-sued.de/smarthematik.svg?label=Aufrufe&color=4f46e5" alt="Seitenaufrufe ZÃ¤hler" className="h-5" />
                                </div>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
